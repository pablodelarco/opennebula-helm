OpenNebula has been installed!

{{- if .Values.mariadb.enabled }}
MariaDB is deployed as a subchart.
{{- end }}

To access the OpenNebula web UI (FireEdge/Sunstone):

{{- if .Values.ingress.enabled }}
{{- if .Values.ingress.tls.enabled }}
   https://{{ .Values.ingress.hostname }}/fireedge/sunstone
{{- else }}
   http://{{ .Values.ingress.hostname }}/fireedge/sunstone
{{- end }}
{{- else if eq .Values.service.type "LoadBalancer" }}
   # Get the external IP:
   kubectl get svc {{ include "opennebula.fullname" . }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}'

   # Then visit: http://<EXTERNAL-IP>:2616/fireedge/sunstone
{{- else if eq .Values.service.type "NodePort" }}
   # Get the NodePort:
   kubectl get svc {{ include "opennebula.fullname" . }} -o jsonpath='{.spec.ports[?(@.name=="fireedge")].nodePort}'

   # Then visit: http://<NODE-IP>:<NODE-PORT>/fireedge/sunstone
{{- else }}
   kubectl port-forward svc/{{ include "opennebula.fullname" . }} 8080:2616

   Then visit: http://localhost:8080/fireedge/sunstone
{{- end }}

{{- if .Values.fireedgeProxy.enabled }}

FireEdge Proxy: ENABLED (auto-detection mode)
   The nginx sidecar automatically replaces __HOST__ placeholders with the
   URL you use to access the web UI. Works with port-forward, NodePort,
   LoadBalancer, and Ingress without any additional configuration.
{{- if .Values.fireedgeProxy.publicURL }}
   Public URL override: {{ .Values.fireedgeProxy.publicURL }}
{{- end }}
{{- else }}

WARNING: FireEdge Proxy is DISABLED
   The web UI may not function correctly. The __HOST__ placeholder in
   FireEdge responses won't be replaced. Enable fireedgeProxy or configure
   an external reverse proxy with sub_filter support.
{{- end }}

Default credentials:
   Username: oneadmin
   Password: {{ .Values.opennebula.adminPassword }}

   IMPORTANT: Change the admin password in production!

Access the oned API:
   kubectl port-forward svc/{{ include "opennebula.fullname" . }} 2633:2633
   oneuser show 0 --endpoint http://localhost:2633

Check pod status:
   kubectl get pods -l app.kubernetes.io/name={{ include "opennebula.name" . }},app.kubernetes.io/instance={{ .Release.Name }}

View logs:
   kubectl logs -f statefulset/{{ include "opennebula.fullname" . }} -c opennebula
{{- if .Values.fireedgeProxy.enabled }}
   kubectl logs -f statefulset/{{ include "opennebula.fullname" . }} -c fireedge-proxy
{{- end }}

{{- if .Values.onedeploy.enabled }}
{{- if .Values.onedeploy.node.hosts }}

================================================================================
HOST PROVISIONING (OneDeploy Integration)
================================================================================

A provisioner job is running to configure your hypervisor nodes.

Check provisioner status:
   kubectl get jobs {{ include "opennebula.fullname" . }}-host-provisioner

View provisioner logs:
   kubectl logs job/{{ include "opennebula.fullname" . }}-host-provisioner -f

Hosts being provisioned:
{{- range $name, $config := .Values.onedeploy.node.hosts }}
   - {{ $name }} ({{ $config.ansible_host }}) - {{ $config.virtualization | default "kvm" }}
{{- end }}

After provisioning completes, verify hosts:
   kubectl exec {{ include "opennebula.fullname" . }}-0 -c opennebula -- onehost list

{{- end }}
{{- else }}

================================================================================
ADDING HYPERVISOR HOSTS
================================================================================

To add KVM/LXC hosts to your OpenNebula deployment:

1. Get the SSH public key:
   kubectl exec {{ include "opennebula.fullname" . }}-0 -c opennebula -- \
     cat /var/lib/one/.ssh/id_rsa.pub

2. On each hypervisor host, install OpenNebula node packages:
   # For KVM (Ubuntu/Debian):
   apt-get install opennebula-node-kvm
   systemctl restart libvirtd

   # For LXC:
   apt-get install opennebula-node-lxc

3. Add the SSH public key to each host:
   mkdir -p /var/lib/one/.ssh
   echo "<PUBLIC_KEY>" >> /var/lib/one/.ssh/authorized_keys
   chown -R 9869:9869 /var/lib/one
   chmod 700 /var/lib/one/.ssh
   chmod 600 /var/lib/one/.ssh/authorized_keys

4. Register hosts:
   kubectl exec {{ include "opennebula.fullname" . }}-0 -c opennebula -- \
     onehost create <hostname> --im kvm --vm kvm

TIP: Enable onedeploy integration to automate this process!
     Set onedeploy.enabled=true and configure onedeploy.node.hosts
     See: https://github.com/pablodelarco/opennebula-helm#host-provisioning

{{- end }}

For more information, visit:
https://github.com/pablodelarco/opennebula-helm
