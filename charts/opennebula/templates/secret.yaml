{{/*
Credentials secret for OpenNebula admin password.
Uses lookup to persist generated password across upgrades.
*/}}
{{- $secretName := printf "%s-credentials" (include "opennebula.fullname" .) }}
{{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace $secretName) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "opennebula.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": keep
type: Opaque
data:
  {{- if $existingSecret }}
  oneadmin-password: {{ index $existingSecret.data "oneadmin-password" }}
  {{- else }}
  oneadmin-password: {{ .Values.opennebula.adminPassword | b64enc | quote }}
  {{- end }}
---
{{/*
External database password secret (only when using external DB without existing secret).
*/}}
{{- if and (not .Values.mariadb.enabled) (not .Values.externalDatabase.existingSecret) .Values.externalDatabase.password }}
{{- $dbSecretName := printf "%s-db-secret" (include "opennebula.fullname" .) }}
{{- $existingDbSecret := (lookup "v1" "Secret" .Release.Namespace $dbSecretName) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $dbSecretName }}
  labels:
    {{- include "opennebula.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": keep
type: Opaque
data:
  {{- if $existingDbSecret }}
  mariadb-password: {{ index $existingDbSecret.data "mariadb-password" }}
  {{- else }}
  mariadb-password: {{ .Values.externalDatabase.password | b64enc | quote }}
  {{- end }}
{{- end }}
---
{{/*
SSH keys secret (only when user provides keys).
SSH keys persist via PV mount at /var/lib/one/.ssh by default.
This secret is for users who want to provide their own keys.
*/}}
{{- if and .Values.ssh (or .Values.ssh.privateKey .Values.ssh.publicKey) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "opennebula.fullname" . }}-ssh
  labels:
    {{- include "opennebula.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if .Values.ssh.privateKey }}
  id_rsa: {{ .Values.ssh.privateKey | quote }}
  {{- end }}
  {{- if .Values.ssh.publicKey }}
  id_rsa.pub: {{ .Values.ssh.publicKey | quote }}
  {{- end }}
{{- end }}
