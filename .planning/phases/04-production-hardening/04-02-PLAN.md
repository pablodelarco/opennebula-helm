---
phase: 04-production-hardening
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - docker/entrypoint.sh
  - charts/opennebula/values.yaml
  - charts/opennebula/templates/statefulset.yaml
autonomous: true

must_haves:
  truths:
    - "Pod hostname is configurable via values.yaml and propagated to oned.conf"
    - "MONITOR_ADDRESS is configurable via values.yaml for hypervisor probe routing"
    - "VNM transparent proxy settings are documented in values.yaml"
    - "Default hostname uses StatefulSet FQDN pattern for stability"
  artifacts:
    - path: "docker/entrypoint.sh"
      provides: "HOSTNAME configuration logic for oned.conf"
      contains: "OPENNEBULA_HOSTNAME"
    - path: "charts/opennebula/values.yaml"
      provides: "Configuration options for hostname and monitorAddress"
      contains: "hostname:"
    - path: "charts/opennebula/templates/statefulset.yaml"
      provides: "Environment variables for hostname configuration"
      contains: "OPENNEBULA_HOSTNAME"
  key_links:
    - from: "charts/opennebula/templates/statefulset.yaml"
      to: "docker/entrypoint.sh"
      via: "OPENNEBULA_HOSTNAME environment variable"
      pattern: "OPENNEBULA_HOSTNAME"
    - from: "charts/opennebula/values.yaml"
      to: "charts/opennebula/templates/statefulset.yaml"
      via: "helm template rendering"
      pattern: ".Values.opennebula.hostname"
---

<objective>
Configure stable hostname and monitoring address settings so hypervisors can reliably communicate with the OpenNebula frontend.

Purpose: Auto-detection of HOSTNAME and MONITOR_ADDRESS fails in containers, returning pod IPs that change on reschedule. This causes hypervisor driver operations and monitoring to fail. Explicit configuration via values.yaml provides stable, predictable addresses.

Output: Entrypoint with HOSTNAME configuration logic, values.yaml with hostname/monitorAddress/vnm settings, StatefulSet with environment variables to pass configuration.
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-production-hardening/04-RESEARCH.md
@.planning/phases/04-production-hardening/04-01-SUMMARY.md

@docker/entrypoint.sh
@charts/opennebula/values.yaml
@charts/opennebula/templates/statefulset.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add HOSTNAME configuration to entrypoint.sh</name>
  <files>docker/entrypoint.sh</files>
  <action>
Add a new section to entrypoint.sh that configures HOSTNAME in oned.conf based on the OPENNEBULA_HOSTNAME environment variable.

Insert this section AFTER the "Service Endpoint Configuration" section (after the OneGate sed command, around line 133) and BEFORE the "Ensure proper ownership" section:

```bash
# ----------------------------------------------------------------------------
# HOSTNAME Configuration for Driver Operations
# ----------------------------------------------------------------------------
# HOSTNAME tells oned what address to advertise to hypervisors for driver operations.
# Auto-detection often fails in containers, returning internal pod IPs.
# Set OPENNEBULA_HOSTNAME to a stable, resolvable address.
OPENNEBULA_HOSTNAME="${OPENNEBULA_HOSTNAME:-}"

if [ -n "$OPENNEBULA_HOSTNAME" ] && [ "$OPENNEBULA_HOSTNAME" != "auto" ]; then
    echo "Setting explicit HOSTNAME in oned.conf: $OPENNEBULA_HOSTNAME"
    # Check if HOSTNAME line exists (commented or not) and update it
    if grep -q "^#*\s*HOSTNAME\s*=" /etc/one/oned.conf; then
        sed -i 's/^#*\s*HOSTNAME\s*=.*/HOSTNAME = "'"${OPENNEBULA_HOSTNAME}"'"/' /etc/one/oned.conf
    else
        # Add HOSTNAME if not present
        echo "HOSTNAME = \"${OPENNEBULA_HOSTNAME}\"" >> /etc/one/oned.conf
    fi
fi

# ----------------------------------------------------------------------------
# MONITOR_ADDRESS Configuration for Monitoring Probes
# ----------------------------------------------------------------------------
# MONITOR_ADDRESS tells hypervisors where to send monitoring data.
# Default "auto" may resolve to wrong address in containerized deployments.
OPENNEBULA_MONITOR_ADDRESS="${OPENNEBULA_MONITOR_ADDRESS:-}"

if [ -n "$OPENNEBULA_MONITOR_ADDRESS" ] && [ "$OPENNEBULA_MONITOR_ADDRESS" != "auto" ]; then
    echo "Setting explicit MONITOR_ADDRESS in monitord.conf: $OPENNEBULA_MONITOR_ADDRESS"
    # Update MONITOR_ADDRESS in the NETWORK section of monitord.conf
    if [ -f /etc/one/monitord.conf ]; then
        sed -i 's/MONITOR_ADDRESS\s*=\s*"[^"]*"/MONITOR_ADDRESS = "'"${OPENNEBULA_MONITOR_ADDRESS}"'"/' /etc/one/monitord.conf
    fi
fi
```

The logic:
- If OPENNEBULA_HOSTNAME is set and not "auto", configure explicit HOSTNAME
- If OPENNEBULA_MONITOR_ADDRESS is set and not "auto", configure explicit MONITOR_ADDRESS
- Empty or "auto" values preserve default behavior (for backward compatibility)
  </action>
  <verify>grep -A5 "HOSTNAME Configuration" docker/entrypoint.sh shows the new section</verify>
  <done>Entrypoint configures HOSTNAME and MONITOR_ADDRESS from environment variables</done>
</task>

<task type="auto">
  <name>Task 2: Add hostname, monitorAddress, and VNM config to values.yaml</name>
  <files>charts/opennebula/values.yaml</files>
  <action>
Add new configuration options to the opennebula section in values.yaml.

Update the opennebula section to add hostname and monitorAddress:

```yaml
## OpenNebula settings
opennebula:
  ## Admin password for oneadmin user
  ## Default: opennebula (override in production!)
  adminPassword: "opennebula"

  ## HOSTNAME for oned.conf - address advertised to hypervisors for driver operations
  ## Options:
  ##   - "" (empty/default) - uses StatefulSet FQDN for stable identity
  ##   - "auto" - let OpenNebula auto-detect (may fail in containers)
  ##   - explicit hostname/IP - use specific value
  ## The default constructs: {release}-opennebula-0.{release}-opennebula-headless.{namespace}.svc.cluster.local
  hostname: ""

  ## MONITOR_ADDRESS for monitord.conf - where hypervisors send monitoring data
  ## Options:
  ##   - "" (empty/default) - uses auto-detection
  ##   - "auto" - same as empty, auto-detect
  ##   - explicit IP/hostname - use specific value
  ## For external hypervisors, set to LoadBalancer IP or NodePort-accessible IP
  monitorAddress: ""
```

Add a new section for VNM transparent proxy configuration AFTER the ssh section (around line 98):

```yaml
## VNM Transparent Proxy configuration
## Required for VMs to access OneGate when using isolated virtual networks
## Note: This is hypervisor-side configuration - the chart provides documentation
## and suggested values. Actual configuration happens on hypervisors via onehost sync.
vnm:
  tproxy:
    ## Enable transparent proxy mode documentation in NOTES.txt
    enabled: false
    ## Remote address for OneGate proxy (frontend address reachable from hypervisors)
    ## If empty, uses the Service address. For external hypervisors, use LoadBalancer IP.
    onegateRemoteAddr: ""
```

The VNM section is primarily documentation since transparent proxy is configured on hypervisors, not in the chart. However, providing the values structure helps users understand what to configure and allows future automation.
  </action>
  <verify>grep -A3 "hostname:" charts/opennebula/values.yaml shows the hostname config; grep -A5 "vnm:" charts/opennebula/values.yaml shows the VNM section</verify>
  <done>values.yaml includes hostname, monitorAddress, and vnm.tproxy configuration options</done>
</task>

<task type="auto">
  <name>Task 3: Add environment variables to StatefulSet for hostname configuration</name>
  <files>charts/opennebula/templates/statefulset.yaml</files>
  <action>
Add environment variables to the opennebula container in the StatefulSet to pass hostname and monitorAddress configuration.

Add these environment variables AFTER the existing DB_PASSWORD env var (around line 89):

```yaml
            # Hostname configuration for driver operations
            - name: OPENNEBULA_HOSTNAME
              {{- if .Values.opennebula.hostname }}
              value: {{ .Values.opennebula.hostname | quote }}
              {{- else }}
              # Default to StatefulSet FQDN for stable identity
              value: "{{ include "opennebula.fullname" . }}-0.{{ include "opennebula.fullname" . }}-headless.{{ .Release.Namespace }}.svc.cluster.local"
              {{- end }}
            # Monitor address for hypervisor probes
            {{- if and .Values.opennebula.monitorAddress (ne .Values.opennebula.monitorAddress "") }}
            - name: OPENNEBULA_MONITOR_ADDRESS
              value: {{ .Values.opennebula.monitorAddress | quote }}
            {{- end }}
```

Key logic:
- OPENNEBULA_HOSTNAME: If empty (default), use the StatefulSet FQDN pattern which is stable across pod reschedules. If user provides explicit value, use it.
- OPENNEBULA_MONITOR_ADDRESS: Only set if user provides explicit value. Empty means "auto" (default OpenNebula behavior).

The StatefulSet FQDN pattern is:
`{statefulset-name}-{ordinal}.{headless-service-name}.{namespace}.svc.cluster.local`

For our chart with release name "my-release":
`my-release-opennebula-0.my-release-opennebula-headless.default.svc.cluster.local`
  </action>
  <verify>grep -A2 "OPENNEBULA_HOSTNAME" charts/opennebula/templates/statefulset.yaml shows the env var definition</verify>
  <done>StatefulSet passes OPENNEBULA_HOSTNAME and OPENNEBULA_MONITOR_ADDRESS to container</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Entrypoint check:
   ```bash
   grep -c "OPENNEBULA_HOSTNAME" docker/entrypoint.sh
   # Expected: 4+ (variable definition, check, echo, sed)
   grep -c "OPENNEBULA_MONITOR_ADDRESS" docker/entrypoint.sh
   # Expected: 4+ (variable definition, check, echo, sed)
   ```

2. Values.yaml check:
   ```bash
   grep "hostname:" charts/opennebula/values.yaml
   # Expected: shows hostname config
   grep "monitorAddress:" charts/opennebula/values.yaml
   # Expected: shows monitorAddress config
   grep "tproxy:" charts/opennebula/values.yaml
   # Expected: shows VNM tproxy section
   ```

3. StatefulSet check:
   ```bash
   grep "OPENNEBULA_HOSTNAME" charts/opennebula/templates/statefulset.yaml
   # Expected: env var name and value
   ```

4. Helm template renders with default values:
   ```bash
   cd charts/opennebula && helm template test . 2>&1 | grep -A1 "OPENNEBULA_HOSTNAME"
   # Expected: shows the StatefulSet FQDN pattern
   ```

5. Helm template renders with custom hostname:
   ```bash
   cd charts/opennebula && helm template test . --set opennebula.hostname="custom.example.com" 2>&1 | grep -A1 "OPENNEBULA_HOSTNAME"
   # Expected: value: "custom.example.com"
   ```
</verification>

<success_criteria>
- Entrypoint configures HOSTNAME in oned.conf when OPENNEBULA_HOSTNAME env var is set
- Entrypoint configures MONITOR_ADDRESS in monitord.conf when OPENNEBULA_MONITOR_ADDRESS env var is set
- values.yaml has opennebula.hostname with StatefulSet FQDN as documented default
- values.yaml has opennebula.monitorAddress for explicit monitor address configuration
- values.yaml has vnm.tproxy section for transparent proxy documentation
- StatefulSet passes OPENNEBULA_HOSTNAME env var to container
- Default OPENNEBULA_HOSTNAME is the StatefulSet FQDN (stable across restarts)
- Helm template renders without errors with default and custom values
</success_criteria>

<output>
After completion, create `.planning/phases/04-production-hardening/04-02-SUMMARY.md`
</output>
