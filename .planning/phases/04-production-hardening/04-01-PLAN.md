---
phase: 04-production-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/Dockerfile
  - charts/opennebula/templates/service.yaml
  - charts/opennebula/templates/statefulset.yaml
autonomous: true

must_haves:
  truths:
    - "Port 4124 TCP is exposed at container, pod, and service level"
    - "Port 4124 UDP is exposed at container, pod, and service level"
    - "Port 22 TCP is exposed at container, pod, and service level"
  artifacts:
    - path: "docker/Dockerfile"
      provides: "EXPOSE directive for ports 4124 and 22"
      contains: "EXPOSE 2633 2616 2474 5030 4124 22"
    - path: "charts/opennebula/templates/service.yaml"
      provides: "Service ports for monitoring and SSH"
      contains: "monitord-tcp"
    - path: "charts/opennebula/templates/statefulset.yaml"
      provides: "Container ports for monitoring and SSH"
      contains: "monitord-tcp"
  key_links:
    - from: "charts/opennebula/templates/statefulset.yaml"
      to: "charts/opennebula/templates/service.yaml"
      via: "port names match between containerPort and service targetPort"
      pattern: "name: monitord-tcp"
---

<objective>
Add missing port exposure for monitoring (4124 TCP+UDP) and SSH (22 TCP) across Dockerfile, Kubernetes Service, and StatefulSet.

Purpose: Hypervisor monitoring agents cannot push metrics and SSH transfer operations fail because these ports are not exposed. This blocks production usage where hypervisors need bidirectional communication with the OpenNebula frontend.

Output: Dockerfile with EXPOSE for new ports, Service with 3 new port definitions, StatefulSet with 3 new containerPorts.
</objective>

<execution_context>
@/home/pablo/.claude/get-shit-done/workflows/execute-plan.md
@/home/pablo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-production-hardening/04-RESEARCH.md

@docker/Dockerfile
@charts/opennebula/templates/service.yaml
@charts/opennebula/templates/statefulset.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add port 4124 and 22 to Dockerfile EXPOSE</name>
  <files>docker/Dockerfile</files>
  <action>
Update the EXPOSE directive in docker/Dockerfile to include ports 4124 and 22.

Current EXPOSE line:
```
EXPOSE 2633 2616 2474 5030
```

Change to:
```
EXPOSE 2633 2616 2474 5030 4124 22
```

Update the comments above EXPOSE to document the new ports:
```dockerfile
# Expose ports
# 2633 - oned XML-RPC API
# 2616 - FireEdge/Sunstone web UI
# 2474 - OneFlow API
# 5030 - OneGate API
# 4124 - Monitord (TCP+UDP for hypervisor monitoring probes)
# 22   - SSH (transfer manager, driver operations)
EXPOSE 2633 2616 2474 5030 4124 22
```

Note: EXPOSE is documentation only in Docker; the actual port binding happens at runtime. However, it's best practice to document all ports the container listens on.
  </action>
  <verify>grep "EXPOSE.*4124.*22" docker/Dockerfile returns the updated line</verify>
  <done>Dockerfile EXPOSE includes 4124 and 22 with updated comments</done>
</task>

<task type="auto">
  <name>Task 2: Add monitoring and SSH ports to Service</name>
  <files>charts/opennebula/templates/service.yaml</files>
  <action>
Add three new port definitions to the external access Service in service.yaml:
1. Port 4124 TCP (monitord-tcp)
2. Port 4124 UDP (monitord-udp) - CRITICAL: same port number, different protocol
3. Port 22 TCP (ssh)

Add these ports to BOTH the headless service (for internal pod DNS) and the external access service.

For the headless service, add after the oned port:
```yaml
    - port: 4124
      targetPort: 4124
      protocol: TCP
      name: monitord-tcp
    - port: 4124
      targetPort: 4124
      protocol: UDP
      name: monitord-udp
    - port: 22
      targetPort: 22
      protocol: TCP
      name: ssh
```

For the external access service, add after the onegate port:
```yaml
    # Monitoring port (TCP) - hypervisor probes
    - port: 4124
      targetPort: 4124
      protocol: TCP
      name: monitord-tcp
    # Monitoring port (UDP) - hypervisor probe messages
    - port: 4124
      targetPort: 4124
      protocol: UDP
      name: monitord-udp
    # SSH for transfer manager operations
    - port: 22
      targetPort: 22
      protocol: TCP
      name: ssh
```

Important: Kubernetes allows the same port number with different protocols in a single Service. The port names MUST be unique (hence monitord-tcp and monitord-udp).
  </action>
  <verify>grep -E "(monitord-tcp|monitord-udp|name: ssh)" charts/opennebula/templates/service.yaml shows all three port names</verify>
  <done>Service exposes ports 4124 TCP, 4124 UDP, and 22 TCP in both headless and external services</done>
</task>

<task type="auto">
  <name>Task 3: Add monitoring and SSH containerPorts to StatefulSet</name>
  <files>charts/opennebula/templates/statefulset.yaml</files>
  <action>
Add three new containerPort definitions to the opennebula container in the StatefulSet.

Add after the existing onegate port definition (around line 68):
```yaml
            # Monitoring ports for hypervisor probes
            - name: monitord-tcp
              containerPort: 4124
              protocol: TCP
            - name: monitord-udp
              containerPort: 4124
              protocol: UDP
            # SSH for transfer manager
            - name: ssh
              containerPort: 22
              protocol: TCP
```

The port names must match those in service.yaml for clarity and consistency. Kubernetes uses containerPort for documentation and network policy purposes - the actual listening happens inside the container.
  </action>
  <verify>grep -E "(monitord-tcp|monitord-udp|containerPort: 22)" charts/opennebula/templates/statefulset.yaml shows all three ports</verify>
  <done>StatefulSet declares containerPorts 4124 TCP, 4124 UDP, and 22 TCP</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Dockerfile check:
   ```bash
   grep "EXPOSE" docker/Dockerfile | grep -q "4124" && grep "EXPOSE" docker/Dockerfile | grep -q "22" && echo "PASS" || echo "FAIL"
   ```

2. Service check:
   ```bash
   grep -c "port: 4124" charts/opennebula/templates/service.yaml
   # Expected: 4 (2 in headless + 2 in external, for TCP and UDP each)
   grep -c "port: 22" charts/opennebula/templates/service.yaml
   # Expected: 2 (1 in headless + 1 in external)
   ```

3. StatefulSet check:
   ```bash
   grep -c "containerPort: 4124" charts/opennebula/templates/statefulset.yaml
   # Expected: 2 (TCP and UDP)
   grep -c "containerPort: 22" charts/opennebula/templates/statefulset.yaml
   # Expected: 1
   ```

4. Helm template renders without errors:
   ```bash
   cd charts/opennebula && helm dependency update && helm template . --debug > /dev/null && echo "PASS" || echo "FAIL"
   ```
</verification>

<success_criteria>
- Port 4124 TCP exposed in Dockerfile, Service (headless + external), and StatefulSet containerPorts
- Port 4124 UDP exposed in Dockerfile (implicit), Service (headless + external), and StatefulSet containerPorts
- Port 22 TCP exposed in Dockerfile, Service (headless + external), and StatefulSet containerPorts
- Helm template renders successfully
- Port names are consistent across Service and StatefulSet (monitord-tcp, monitord-udp, ssh)
</success_criteria>

<output>
After completion, create `.planning/phases/04-production-hardening/04-01-SUMMARY.md`
</output>
