---
phase: 01-docker-image
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Docker image builds successfully"
    - "Container starts without errors"
    - "oned API responds on port 2633"
    - "All 4 services are running in the container"
    - "Environment variables configure the container correctly"
  artifacts:
    - path: "docker image"
      provides: "Working OpenNebula 7.0 control plane"
      contains: "pablodelarco/opennebula-frontend:7.0-test"
  key_links:
    - from: "entrypoint.sh"
      to: "oned.conf"
      via: "sed commands for DB configuration"
      pattern: "sed.*oned.conf"
    - from: "supervisord"
      to: "services"
      via: "process management"
      pattern: "supervisorctl status"
---

<objective>
Build and verify the OpenNebula 7.0 Docker image

Purpose: Validate that the Dockerfile, supervisord config, and entrypoint script work together to produce a functional OpenNebula control plane container. This verifies IMG-01 through IMG-05 requirements are met.

Output: A tested Docker image that can be used locally or pushed to Docker Hub
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-docker-image/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Docker image</name>
  <files></files>
  <action>
Build the Docker image using the files created in Plan 01:

1. Navigate to the repository root
2. Run: docker build -t pablodelarco/opennebula-frontend:7.0-test -f docker/Dockerfile docker/
3. Capture build output for debugging if needed
4. Verify build completes successfully (exit code 0)

If build fails:
- Check for package availability issues (OpenNebula repo)
- Check for syntax errors in Dockerfile
- Review error messages and fix issues in docker/Dockerfile, docker/supervisord.conf, or docker/entrypoint.sh as needed

Build should take 5-15 minutes depending on network speed and cache state.
  </action>
  <verify>docker images | grep "pablodelarco/opennebula-frontend" shows the image with tag 7.0-test</verify>
  <done>Image pablodelarco/opennebula-frontend:7.0-test exists locally</done>
</task>

<task type="auto">
  <name>Task 2: Start container and verify services</name>
  <files></files>
  <action>
Start the container and verify all services are running:

1. Start container in detached mode:
   docker run -d --name opennebula-test \
     -p 2633:2633 \
     -p 2616:2616 \
     -p 2474:2474 \
     -p 5030:5030 \
     -e ONEADMIN_PASSWORD=testpassword123 \
     pablodelarco/opennebula-frontend:7.0-test

2. Wait for services to start (60 seconds for start-period):
   sleep 65

3. Check container is running:
   docker ps | grep opennebula-test

4. Check supervisord status for all services:
   docker exec opennebula-test supervisorctl status
   Expected: oned, fireedge, oneflow, onegate all showing RUNNING

5. Verify oned API is responding:
   docker exec opennebula-test oneuser show 0
   Expected: Shows oneadmin user details

6. Check logs for errors:
   docker exec opennebula-test cat /var/log/one/oned.log | tail -20
   docker exec opennebula-test cat /var/log/one/fireedge.log | tail -20

7. Test port accessibility from host:
   curl -s http://localhost:2633/RPC2 | head -5
   (Should return XML-RPC response, even if error - proves port is open)

If any service fails:
- Check specific service log: docker exec opennebula-test cat /var/log/one/{service}.error
- Fix configuration issues and rebuild if needed
- Common issues: permissions, missing auth files, service dependencies
  </action>
  <verify>docker exec opennebula-test supervisorctl status shows all 4 services (oned, fireedge, oneflow, onegate) as RUNNING</verify>
  <done>Container runs with all services active, oned API responds to oneuser command</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete OpenNebula 7.0 Docker image with all control plane services running via supervisord:
- oned (main daemon) on port 2633
- FireEdge/Sunstone (web UI) on port 2616
- OneFlow (service orchestration) on port 2474
- OneGate (VM communication) on port 5030
  </what-built>
  <how-to-verify>
1. Open browser to http://localhost:2616
   - You should see the OpenNebula Sunstone login page (via FireEdge)
   - Login with username: oneadmin, password: testpassword123

2. From CLI, test the API:
   docker exec opennebula-test onehost list
   docker exec opennebula-test onevm list
   (Both should return empty lists, not errors)

3. Verify healthcheck is passing:
   docker inspect opennebula-test | grep -A5 '"Health"'
   Status should be "healthy"

Expected results:
- Sunstone web UI loads and accepts login
- CLI commands work without authentication errors
- Healthcheck shows healthy status
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks and checkpoint:
1. Docker image exists: pablodelarco/opennebula-frontend:7.0-test
2. Container runs successfully with all 4 services
3. oned API accessible on port 2633
4. Sunstone/FireEdge accessible on port 2616
5. Environment variables work (ONEADMIN_PASSWORD was used)
6. Healthcheck passes
</verification>

<success_criteria>
Phase 1 is complete when:
- [x] IMG-01: Ubuntu 24.04 LTS base (verified in Dockerfile FROM)
- [x] IMG-02: OpenNebula 7.0 packages installed (verified by oneuser command)
- [x] IMG-03: Services start without systemd (verified by supervisorctl)
- [x] IMG-04: Configuration via environment variables (verified by ONEADMIN_PASSWORD)
- [x] IMG-05: All services running (verified by supervisorctl status)
</success_criteria>

<output>
After completion, create `.planning/phases/01-docker-image/01-02-SUMMARY.md`
</output>

<cleanup>
After verification is complete and checkpoint is approved:
docker stop opennebula-test
docker rm opennebula-test
</cleanup>
