---
phase: 01-docker-image
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/Dockerfile
  - docker/supervisord.conf
  - docker/entrypoint.sh
autonomous: true

must_haves:
  truths:
    - "Dockerfile builds without errors"
    - "All OpenNebula 7.0 packages are installed"
    - "supervisord configuration manages all 4 services"
    - "entrypoint configures auth files and database settings"
  artifacts:
    - path: "docker/Dockerfile"
      provides: "Multi-stage or single-stage build for OpenNebula 7.0"
      contains: "FROM ubuntu:24.04"
    - path: "docker/supervisord.conf"
      provides: "Process management for oned, fireedge, oneflow, onegate"
      contains: "[program:oned]"
    - path: "docker/entrypoint.sh"
      provides: "Runtime configuration via environment variables"
      contains: "ONEADMIN_PASSWORD"
  key_links:
    - from: "docker/Dockerfile"
      to: "docker/supervisord.conf"
      via: "COPY instruction"
      pattern: "COPY.*supervisord"
    - from: "docker/Dockerfile"
      to: "docker/entrypoint.sh"
      via: "COPY and ENTRYPOINT instructions"
      pattern: "ENTRYPOINT.*entrypoint"
---

<objective>
Create the Docker image source files for OpenNebula 7.0 control plane

Purpose: Establish the complete Docker build configuration that installs OpenNebula 7.0 packages on Ubuntu 24.04, uses supervisord for process management (no systemd), and configures services via environment variables at runtime.

Output: Three files ready for docker build - Dockerfile, supervisord.conf, entrypoint.sh
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-docker-image/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile with OpenNebula 7.0 packages</name>
  <files>docker/Dockerfile</files>
  <action>
Create a Dockerfile that:

1. Uses `FROM ubuntu:24.04` as base image

2. Sets environment variables to prevent interactive prompts and systemd:
   - `DEBIAN_FRONTEND=noninteractive`
   - `RUNLEVEL=1`

3. Installs prerequisites:
   - gnupg2, wget, apt-transport-https, ca-certificates
   - supervisor (for process management)

4. Adds OpenNebula 7.0 repository:
   - Download and install GPG key to /etc/apt/keyrings/opennebula.gpg
   - Add repo: `deb [signed-by=/etc/apt/keyrings/opennebula.gpg] https://downloads.opennebula.io/repo/7.0/Ubuntu/24.04 stable opennebula`

5. Installs OpenNebula packages (with RUNLEVEL=1):
   - opennebula
   - opennebula-fireedge
   - opennebula-flow
   - opennebula-gate
   - opennebula-tools

6. Cleans apt cache to reduce image size

7. Creates required directories:
   - /var/log/one (owned by oneadmin:oneadmin)
   - /var/lib/one/.one (owned by oneadmin:oneadmin)
   - /var/lib/one/.ssh (owned by oneadmin:oneadmin, mode 700)

8. Copies configuration files:
   - COPY supervisord.conf /etc/supervisor/conf.d/opennebula.conf
   - COPY entrypoint.sh /entrypoint.sh
   - Make entrypoint.sh executable (RUN chmod +x)

9. Exposes ports:
   - 2633 (oned XML-RPC API)
   - 2616 (FireEdge/Sunstone web UI)
   - 2474 (OneFlow API)
   - 5030 (OneGate API)

10. Sets healthcheck:
    - Use `oneuser show 0` command
    - --interval=30s --timeout=10s --start-period=60s --retries=3

11. Sets entrypoint and command:
    - ENTRYPOINT ["/entrypoint.sh"]
    - CMD ["supervisord", "-n", "-c", "/etc/supervisor/supervisord.conf"]

Note: Do NOT try to start scheduler service - in OpenNebula 7.0 it runs on demand, not as a daemon.
  </action>
  <verify>docker build -t test-dockerfile -f docker/Dockerfile docker/ completes without errors (do not run yet, just verify syntax)</verify>
  <done>Dockerfile exists at docker/Dockerfile with all required sections and follows the research patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create supervisord config and entrypoint script</name>
  <files>docker/supervisord.conf, docker/entrypoint.sh</files>
  <action>
Create supervisord.conf with the following programs:

1. [program:oned]
   - command=/usr/bin/oned -f
   - user=oneadmin
   - autostart=true
   - autorestart=true
   - stdout_logfile=/var/log/one/oned.log
   - stderr_logfile=/var/log/one/oned.error
   - priority=10 (starts first)

2. [program:fireedge]
   - command=/usr/bin/node /usr/lib/one/fireedge/dist/index.js
   - user=oneadmin
   - autostart=true
   - autorestart=true
   - stdout_logfile=/var/log/one/fireedge.log
   - stderr_logfile=/var/log/one/fireedge.error
   - priority=20 (starts after oned)

3. [program:oneflow]
   - command=/usr/bin/ruby /usr/lib/one/oneflow/oneflow-server.rb
   - user=oneadmin
   - autostart=true
   - autorestart=true
   - stdout_logfile=/var/log/one/oneflow.log
   - stderr_logfile=/var/log/one/oneflow.error
   - priority=20

4. [program:onegate]
   - command=/usr/bin/ruby /usr/lib/one/onegate/onegate-server.rb
   - user=oneadmin
   - autostart=true
   - autorestart=true
   - stdout_logfile=/var/log/one/onegate.log
   - stderr_logfile=/var/log/one/onegate.error
   - priority=20

Create entrypoint.sh that:

1. Starts with `#!/bin/bash` and `set -e`

2. Generates SSH keys for oneadmin if not present:
   - Check if /var/lib/one/.ssh/id_rsa exists
   - If not, run: sudo -u oneadmin ssh-keygen -t rsa -N "" -f /var/lib/one/.ssh/id_rsa
   - Add public key to authorized_keys
   - Set proper permissions (600 on authorized_keys)

3. Sets up authentication files:
   - ONEADMIN_PASSWORD defaults to "oneadmin" if not set
   - Create /var/lib/one/.one/one_auth with "oneadmin:${ONEADMIN_PASSWORD}"
   - Create /var/lib/one/.one/oneflow_auth with "serveradmin:${ONEADMIN_PASSWORD}"
   - Create /var/lib/one/.one/onegate_auth with "serveradmin:${ONEADMIN_PASSWORD}"
   - Set ownership to oneadmin:oneadmin, mode 600

4. Configures database backend if DB_BACKEND is set to "mysql":
   - Use sed to modify /etc/one/oned.conf
   - Change BACKEND = "sqlite" to BACKEND = "mysql"
   - Set SERVER, PORT, USER, PASSWD, DB_NAME from env vars (DB_HOST, DB_PORT, DB_USER, DB_PASSWORD, DB_NAME)
   - Default values: DB_HOST=localhost, DB_PORT=3306, DB_USER=oneadmin, DB_NAME=opennebula

5. Configures service endpoints to listen on 0.0.0.0:
   - Modify /etc/one/oneflow-server.conf: set :host: to 0.0.0.0
   - Modify /etc/one/onegate-server.conf: set :host: to 0.0.0.0

6. Ends with `exec "$@"` to run the CMD

Environment variables supported:
- ONEADMIN_PASSWORD (default: oneadmin)
- DB_BACKEND (default: sqlite, options: sqlite, mysql)
- DB_HOST (default: localhost)
- DB_PORT (default: 3306)
- DB_USER (default: oneadmin)
- DB_PASSWORD (required if DB_BACKEND=mysql)
- DB_NAME (default: opennebula)
  </action>
  <verify>bash -n docker/entrypoint.sh (syntax check) passes without errors</verify>
  <done>Both supervisord.conf and entrypoint.sh exist with proper structure, entrypoint handles all required environment variables</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. All three files exist in docker/ directory
2. Dockerfile references supervisord.conf and entrypoint.sh correctly
3. entrypoint.sh is syntactically valid bash
4. supervisord.conf has all 4 program definitions
</verification>

<success_criteria>
- docker/Dockerfile exists with Ubuntu 24.04 base, OpenNebula 7.0 repo, all packages
- docker/supervisord.conf exists with oned, fireedge, oneflow, onegate programs
- docker/entrypoint.sh exists with auth file setup and database configuration
- Files are ready for docker build (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-docker-image/01-01-SUMMARY.md`
</output>
