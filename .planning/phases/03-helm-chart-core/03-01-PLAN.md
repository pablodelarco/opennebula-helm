---
phase: 03-helm-chart-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - charts/opennebula/Chart.yaml
  - charts/opennebula/values.yaml
  - charts/opennebula/templates/_helpers.tpl
  - charts/opennebula/.helmignore
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Chart.yaml declares mariadb as conditional dependency"
    - "values.yaml contains all configurable options for HELM-07"
    - "_helpers.tpl provides standard label and name functions"
  artifacts:
    - path: "charts/opennebula/Chart.yaml"
      provides: "Chart metadata with MariaDB dependency"
      contains: "dependencies:"
    - path: "charts/opennebula/values.yaml"
      provides: "Default configuration values"
      contains: "mariadb:"
    - path: "charts/opennebula/templates/_helpers.tpl"
      provides: "Template helper functions"
      contains: "opennebula.labels"
  key_links:
    - from: "Chart.yaml"
      to: "values.yaml"
      via: "dependency condition"
      pattern: "condition: mariadb.enabled"
---

<objective>
Create Helm chart skeleton with Chart.yaml, values.yaml, and template helpers.

Purpose: Establish the chart structure and dependency configuration that all other templates will use.
Output: Working chart scaffold that can be linted with `helm lint`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-helm-chart-core/03-CONTEXT.md
@.planning/phases/03-helm-chart-core/03-RESEARCH.md
@docker/entrypoint.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Chart.yaml with MariaDB dependency</name>
  <files>charts/opennebula/Chart.yaml, charts/opennebula/.helmignore</files>
  <action>
Create the chart directory structure and Chart.yaml:

```yaml
apiVersion: v2
name: opennebula
description: A Helm chart for OpenNebula cloud management platform
type: application
version: 0.1.0
appVersion: "7.0.0"
home: https://github.com/pablodelarco/opennebula-helm
maintainers:
  - name: pablodelarco
keywords:
  - opennebula
  - cloud
  - virtualization

dependencies:
  - name: mariadb
    version: "~14.0"
    repository: "oci://registry-1.docker.io/bitnamicharts"
    condition: mariadb.enabled
```

Also create .helmignore with standard patterns (*.tgz, .git, etc).
  </action>
  <verify>
```bash
helm lint charts/opennebula --set mariadb.enabled=false 2>&1 | grep -E "(ERROR|Chart)"
```
Should show chart name, no errors (warnings about missing templates expected).
  </verify>
  <done>Chart.yaml exists with correct apiVersion v2, mariadb dependency declared with OCI registry and condition.</done>
</task>

<task type="auto">
  <name>Task 2: Create values.yaml with all configuration options</name>
  <files>charts/opennebula/values.yaml</files>
  <action>
Create values.yaml covering all HELM-07 requirements:

```yaml
# OpenNebula Helm Chart Values
# See: https://github.com/pablodelarco/opennebula-helm

## Image configuration
image:
  repository: pablodelarco/opennebula
  tag: "latest"
  pullPolicy: IfNotPresent

## OpenNebula settings
opennebula:
  ## Admin password for oneadmin user
  ## Default: opennebula (override in production!)
  adminPassword: "opennebula"

## MariaDB subchart configuration
## ref: https://github.com/bitnami/charts/tree/main/bitnami/mariadb
mariadb:
  enabled: true
  architecture: standalone
  auth:
    database: opennebula
    username: oneadmin
    ## Password is auto-generated if not set
    # password: ""
  primary:
    persistence:
      enabled: true
      size: 8Gi

## External database configuration (when mariadb.enabled=false)
## Required fields when using external database
externalDatabase:
  host: ""
  port: 3306
  database: opennebula
  username: oneadmin
  ## Password for external database
  password: ""
  ## Or use existing secret (takes precedence over password)
  ## Secret must contain key 'mariadb-password'
  existingSecret: ""

## Persistence for OpenNebula data (/var/lib/one)
persistence:
  enabled: true
  size: 20Gi
  ## storageClass: ""  # Use cluster default
  accessMode: ReadWriteOnce

## Service configuration
service:
  type: ClusterIP
  ## Ports exposed
  ## oned: 2633, sunstone: 9869, fireedge: 2616
  ## oneflow: 2474, onegate: 5030

## Ingress configuration for FireEdge web UI
ingress:
  enabled: false
  className: ""
  annotations: {}
  hostname: opennebula.local
  ## TLS not supported in v1

## SSH keys for hypervisor communication
## If not provided, keys will be generated and stored in a persistent secret
ssh:
  ## Provide existing keys (base64 encoded)
  # privateKey: ""
  # publicKey: ""

## Resource limits and requests
## No defaults - set based on your environment
resources: {}
  # limits:
  #   cpu: 2
  #   memory: 4Gi
  # requests:
  #   cpu: 500m
  #   memory: 1Gi

## Pod security context
podSecurityContext: {}

## Container security context
securityContext: {}

## Node selector
nodeSelector: {}

## Tolerations
tolerations: []

## Affinity
affinity: {}
```

Key points:
- mariadb.enabled: true by default (HELM-02)
- externalDatabase section added for when mariadb.enabled=false
- persistence.size: 20Gi (from CONTEXT.md)
- ingress.enabled: false (from CONTEXT.md)
- resources: {} empty (from CONTEXT.md - no defaults)
- adminPassword defaults to "opennebula" (from CONTEXT.md)
  </action>
  <verify>
```bash
helm lint charts/opennebula --set mariadb.enabled=false 2>&1 | grep -q "ERROR" && echo "FAIL" || echo "PASS"
```
Should output PASS.
  </verify>
  <done>values.yaml contains all configurable options: image, opennebula, mariadb, externalDatabase, persistence, service, ingress, ssh, resources.</done>
</task>

<task type="auto">
  <name>Task 3: Create _helpers.tpl with standard template functions</name>
  <files>charts/opennebula/templates/_helpers.tpl</files>
  <action>
Create _helpers.tpl with standard Helm helper functions:

```yaml
{{/*
Expand the name of the chart.
*/}}
{{- define "opennebula.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a default fully qualified app name.
*/}}
{{- define "opennebula.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- $name := default .Chart.Name .Values.nameOverride }}
{{- if contains $name .Release.Name }}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
{{- end }}

{{/*
Create chart name and version as used by the chart label.
*/}}
{{- define "opennebula.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Common labels
*/}}
{{- define "opennebula.labels" -}}
helm.sh/chart: {{ include "opennebula.chart" . }}
{{ include "opennebula.selectorLabels" . }}
{{- if .Chart.AppVersion }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
{{- end }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{/*
Selector labels (immutable - used in StatefulSet selector)
*/}}
{{- define "opennebula.selectorLabels" -}}
app.kubernetes.io/name: {{ include "opennebula.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{/*
MariaDB host - handles both enabled subchart and external DB scenarios
*/}}
{{- define "opennebula.mariadb.host" -}}
{{- if .Values.mariadb.enabled }}
{{- printf "%s-mariadb" (include "opennebula.fullname" .) }}
{{- else }}
{{- required "externalDatabase.host is required when mariadb.enabled=false" .Values.externalDatabase.host }}
{{- end }}
{{- end }}

{{/*
MariaDB port
*/}}
{{- define "opennebula.mariadb.port" -}}
{{- if .Values.mariadb.enabled }}
{{- 3306 }}
{{- else }}
{{- .Values.externalDatabase.port | default 3306 }}
{{- end }}
{{- end }}

{{/*
MariaDB database name
*/}}
{{- define "opennebula.mariadb.database" -}}
{{- if .Values.mariadb.enabled }}
{{- .Values.mariadb.auth.database }}
{{- else }}
{{- .Values.externalDatabase.database }}
{{- end }}
{{- end }}

{{/*
MariaDB username
*/}}
{{- define "opennebula.mariadb.username" -}}
{{- if .Values.mariadb.enabled }}
{{- .Values.mariadb.auth.username }}
{{- else }}
{{- .Values.externalDatabase.username }}
{{- end }}
{{- end }}

{{/*
MariaDB secret name - from subchart secret or external secret
*/}}
{{- define "opennebula.mariadb.secretName" -}}
{{- if .Values.mariadb.enabled }}
{{- printf "%s-mariadb" (include "opennebula.fullname" .) }}
{{- else if .Values.externalDatabase.existingSecret }}
{{- .Values.externalDatabase.existingSecret }}
{{- else }}
{{- printf "%s-db-secret" (include "opennebula.fullname" .) }}
{{- end }}
{{- end }}
```

These helpers follow Helm best practices from research:
- Selector labels are minimal and immutable (only name + instance)
- Full labels include version and chart metadata
- MariaDB helpers support both subchart and external DB with proper defaults
- Added mariadb.port, mariadb.database, mariadb.username helpers for complete wiring
  </action>
  <verify>
```bash
helm template test charts/opennebula --set mariadb.enabled=false --set externalDatabase.host=mydb.example.com --debug 2>&1 | grep -q "Error" && echo "FAIL" || echo "PASS"
```
Should output PASS (no template errors, though no rendered output yet).
  </verify>
  <done>_helpers.tpl provides opennebula.name, opennebula.fullname, opennebula.labels, opennebula.selectorLabels, opennebula.mariadb.host, opennebula.mariadb.port, opennebula.mariadb.database, opennebula.mariadb.username, opennebula.mariadb.secretName functions.</done>
</task>

</tasks>

<verification>
After all tasks:
```bash
# Directory structure exists
ls -la charts/opennebula/

# Chart is valid
helm lint charts/opennebula --set mariadb.enabled=false --set externalDatabase.host=test.local

# Dependencies can be resolved (dry-run)
helm dependency list charts/opennebula
```
</verification>

<success_criteria>
- charts/opennebula/ directory created with Chart.yaml, values.yaml, templates/_helpers.tpl
- `helm lint` passes without errors (warnings about missing templates OK)
- Chart.yaml declares mariadb dependency with OCI registry and condition
- values.yaml contains all HELM-07 configurable options including externalDatabase section
- _helpers.tpl defines standard name, label, selector, and database helper functions
</success_criteria>

<output>
After completion, create `.planning/phases/03-helm-chart-core/03-01-SUMMARY.md`
</output>
