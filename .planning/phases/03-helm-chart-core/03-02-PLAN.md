---
phase: 03-helm-chart-core
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - charts/opennebula/templates/statefulset.yaml
  - charts/opennebula/templates/service.yaml
  - charts/opennebula/templates/configmap.yaml
  - charts/opennebula/templates/secret.yaml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "StatefulSet creates pod with persistent volume for /var/lib/one (HELM-01)"
    - "Service exposes oned API, FireEdge, and other ports (HELM-05)"
    - "ConfigMap manages oned.conf with database connection (HELM-04)"
    - "Secret stores SSH keys and credentials (HELM-03)"
    - "Liveness probe checks oned API health (HELM-05)"
  artifacts:
    - path: "charts/opennebula/templates/statefulset.yaml"
      provides: "OpenNebula pod with volumeClaimTemplates"
      contains: "volumeClaimTemplates"
    - path: "charts/opennebula/templates/service.yaml"
      provides: "ClusterIP service for all ports"
      contains: "port: 2633"
    - path: "charts/opennebula/templates/configmap.yaml"
      provides: "oned.conf configuration"
      contains: "oned.conf"
    - path: "charts/opennebula/templates/secret.yaml"
      provides: "Credentials and SSH keys"
      contains: "opennebula.fullname"
  key_links:
    - from: "statefulset.yaml"
      to: "secret.yaml"
      via: "envFrom secretRef"
      pattern: "secretRef"
    - from: "statefulset.yaml"
      to: "configmap.yaml"
      via: "volume mount"
      pattern: "configMap"
    - from: "statefulset.yaml"
      to: "service.yaml"
      via: "serviceName"
      pattern: "serviceName:"
---

<objective>
Create core Kubernetes templates: StatefulSet, Service, ConfigMap, and Secret.

Purpose: Deploy oned as StatefulSet with persistent storage, proper networking, and configuration management.
Output: Templates that render valid Kubernetes manifests covering HELM-01 through HELM-05.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-helm-chart-core/03-CONTEXT.md
@.planning/phases/03-helm-chart-core/03-RESEARCH.md
@.planning/phases/03-helm-chart-core/03-01-SUMMARY.md
@docker/entrypoint.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatefulSet template with persistence and probes</name>
  <files>charts/opennebula/templates/statefulset.yaml</files>
  <action>
Create statefulset.yaml implementing HELM-01 (StatefulSet with PV) and HELM-05 (probes):

Key requirements:
1. StatefulSet with serviceName matching headless service
2. volumeClaimTemplates for /var/lib/one (persistence.size from values)
3. InitContainer to wait for MariaDB (when enabled)
4. Environment variables from secret (DB_*, ONEADMIN_PASSWORD)
5. Volume mounts: data volume + SSH keys secret + config maps
6. Liveness probe: `oneuser show 0` (exec probe from research)
7. Readiness probe: same command, faster intervals
8. Resource limits from values (optional)

Container ports to expose:
- 2633 (oned API)
- 9869 (sunstone - deprecated but may be used)
- 2616 (fireedge)
- 2474 (oneflow)
- 5030 (onegate)

InitContainer pattern (from RESEARCH.md):
```yaml
initContainers:
  {{- if .Values.mariadb.enabled }}
  - name: wait-for-mariadb
    image: busybox:1.36
    command: ['sh', '-c', 'until nc -z {{ include "opennebula.mariadb.host" . }} 3306; do echo "Waiting for MariaDB..."; sleep 5; done']
  {{- end }}
```

Probe pattern (from RESEARCH.md):
```yaml
livenessProbe:
  exec:
    command: ["/bin/bash", "-c", "oneuser show 0 > /dev/null 2>&1"]
  initialDelaySeconds: 120  # oned takes time to start
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 3
readinessProbe:
  exec:
    command: ["/bin/bash", "-c", "oneuser show 0 > /dev/null 2>&1"]
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
```

Mount SSH keys from secret to /var/lib/one/.ssh/ with mode 0600.
Mount config from configmap to /etc/one/ (optional override).

Environment variables needed by entrypoint.sh:
- ONEADMIN_PASSWORD (from secret)
- DB_BACKEND=mysql (when mariadb enabled)
- DB_HOST (from mariadb.host helper)
- DB_PORT=3306
- DB_USER (from values.mariadb.auth.username)
- DB_PASSWORD (from mariadb secret)
- DB_NAME (from values.mariadb.auth.database)
  </action>
  <verify>
```bash
helm template test charts/opennebula --set mariadb.enabled=false 2>&1 | grep -q "kind: StatefulSet" && echo "PASS" || echo "FAIL"
```
  </verify>
  <done>StatefulSet template creates pod with volumeClaimTemplates, init container, liveness/readiness probes, and environment from secrets.</done>
</task>

<task type="auto">
  <name>Task 2: Create Service template for all OpenNebula ports</name>
  <files>charts/opennebula/templates/service.yaml</files>
  <action>
Create service.yaml with:

1. Headless service (clusterIP: None) for StatefulSet - required for stable network identity
2. ClusterIP service for external access with all ports:
   - oned: 2633
   - fireedge: 2616
   - oneflow: 2474
   - onegate: 5030

Pattern:
```yaml
# Headless service for StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: {{ include "opennebula.fullname" . }}-headless
  labels:
    {{- include "opennebula.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  clusterIP: None
  selector:
    {{- include "opennebula.selectorLabels" . | nindent 4 }}
  ports:
    - port: 2633
      name: oned
---
# External access service
apiVersion: v1
kind: Service
metadata:
  name: {{ include "opennebula.fullname" . }}
spec:
  type: {{ .Values.service.type }}
  selector:
    {{- include "opennebula.selectorLabels" . | nindent 4 }}
  ports:
    - port: 2633
      targetPort: 2633
      name: oned
    - port: 2616
      targetPort: 2616
      name: fireedge
    - port: 2474
      targetPort: 2474
      name: oneflow
    - port: 5030
      targetPort: 5030
      name: onegate
```

StatefulSet serviceName must reference the headless service name.
  </action>
  <verify>
```bash
helm template test charts/opennebula --set mariadb.enabled=false 2>&1 | grep -c "kind: Service"
```
Should output 2 (headless + main service).
  </verify>
  <done>Two services created: headless for StatefulSet and ClusterIP for external access with all OpenNebula ports.</done>
</task>

<task type="auto">
  <name>Task 3: Create Secret and ConfigMap templates</name>
  <files>charts/opennebula/templates/secret.yaml, charts/opennebula/templates/configmap.yaml</files>
  <action>
Create secret.yaml implementing HELM-03 (SSH keys in secrets):

Use lookup function pattern from RESEARCH.md to persist credentials across upgrades:
```yaml
{{- $secretName := printf "%s-credentials" (include "opennebula.fullname" .) }}
{{- $existingSecret := (lookup "v1" "Secret" .Release.Namespace $secretName) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "opennebula.labels" . | nindent 4 }}
  annotations:
    "helm.sh/resource-policy": keep
type: Opaque
data:
  {{- if $existingSecret }}
  oneadmin-password: {{ index $existingSecret.data "oneadmin-password" }}
  {{- else }}
  oneadmin-password: {{ .Values.opennebula.adminPassword | b64enc | quote }}
  {{- end }}
```

For SSH keys (HELM-03):
- If values.ssh.privateKey/publicKey provided, use those
- If existing secret found via lookup, preserve those
- Otherwise, keys generated by container entrypoint on first start
- Add "helm.sh/resource-policy: keep" to prevent deletion

Create configmap.yaml implementing HELM-04 (config via ConfigMaps):
- Store any additional config files needed
- Note: Main oned.conf database config is handled by entrypoint.sh via environment variables
- ConfigMap can hold customizations or overrides user wants to apply

For now, ConfigMap can be minimal - entrypoint.sh handles DB config dynamically.
  </action>
  <verify>
```bash
helm template test charts/opennebula --set mariadb.enabled=false 2>&1 | grep -E "kind: (Secret|ConfigMap)" | wc -l
```
Should output at least 2 (one Secret, one ConfigMap).
  </verify>
  <done>Secret stores admin password and SSH keys with lookup persistence. ConfigMap provides config file management.</done>
</task>

</tasks>

<verification>
After all tasks:
```bash
# Lint the chart
helm lint charts/opennebula --set mariadb.enabled=false

# Template renders without errors
helm template test charts/opennebula --set mariadb.enabled=false

# Verify all resources present
helm template test charts/opennebula --set mariadb.enabled=false | grep "kind:" | sort | uniq -c
```

Expected kinds: StatefulSet (1), Service (2), Secret (1+), ConfigMap (1).
</verification>

<success_criteria>
- StatefulSet template with volumeClaimTemplates for HELM-01
- InitContainer waits for MariaDB when enabled
- Liveness and readiness probes using `oneuser show 0` for HELM-05
- Service exposes all required ports (2633, 2616, 2474, 5030)
- Secret uses lookup function to persist SSH keys across upgrades for HELM-03
- ConfigMap provides configuration management for HELM-04
- `helm template` renders all resources without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-helm-chart-core/03-02-SUMMARY.md`
</output>
