---
phase: 03-helm-chart-core
plan: 02
subsystem: helm-chart
tags: [helm, kubernetes, statefulset, service, secret, configmap]

dependency-graph:
  requires:
    - phase: 03-01
      provides: chart scaffold, values.yaml, template helpers
  provides:
    - StatefulSet with persistent storage (HELM-01)
    - Service for all OpenNebula ports (HELM-05)
    - Secret for credentials with lookup persistence (HELM-03)
    - ConfigMap for configuration management (HELM-04)
    - Liveness/readiness probes (HELM-05)
  affects: [03-03, 03-04]

tech-stack:
  added: []
  patterns: [statefulset-with-headless-service, secret-lookup-persistence, init-container-wait]

key-files:
  created:
    - charts/opennebula/templates/statefulset.yaml
    - charts/opennebula/templates/service.yaml
    - charts/opennebula/templates/secret.yaml
    - charts/opennebula/templates/configmap.yaml
  modified: []

key-decisions:
  - "InitContainer pattern for MariaDB wait using busybox nc"
  - "oneuser show 0 for health probes (exec-based, not HTTP)"
  - "lookup function for secret persistence across upgrades"
  - "Headless service for StatefulSet stable network identity"
  - "SSH keys persist via PV, optional user-provided keys via secret"

patterns-established:
  - "Headless service naming: {fullname}-headless"
  - "Credentials secret naming: {fullname}-credentials"
  - "DB secret naming: {fullname}-db-secret"
  - "Safe nil-check: and .Values.ssh (or .Values.ssh.key ...)"

metrics:
  duration: 6 min
  tasks: 3/3
  commits: 3
  completed: 2026-01-24
---

# Phase 03 Plan 02: Core Kubernetes Templates Summary

**StatefulSet with volumeClaimTemplates, dual Service (headless + external), Secret with lookup persistence, and ConfigMap for OpenNebula deployment on Kubernetes**

## Performance

- **Duration:** 6 min
- **Started:** 2026-01-24T17:15:36Z
- **Completed:** 2026-01-24T17:22:22Z
- **Tasks:** 3
- **Files created:** 4

## Accomplishments

- StatefulSet with spec.serviceName pointing to headless service for stable pod identity
- volumeClaimTemplates for /var/lib/one persistence (HELM-01)
- InitContainer to wait for MariaDB when subchart enabled
- Liveness/readiness probes using `oneuser show 0` command (HELM-05)
- Headless service (clusterIP: None) + ClusterIP service with ports 2633, 2616, 2474, 5030
- Credentials secret with Helm lookup function for upgrade persistence (HELM-03)
- External database password secret when mariadb.enabled=false
- ConfigMap placeholder for future configuration overrides (HELM-04)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create StatefulSet template with persistence and probes** - `5a2e636` (feat)
2. **Task 2: Create Service template for all OpenNebula ports** - `ca54d81` (feat)
3. **Task 3: Create Secret and ConfigMap templates** - `9fd147a` (feat)

## Files Created

- `charts/opennebula/templates/statefulset.yaml` - StatefulSet with volumeClaimTemplates, probes, env vars
- `charts/opennebula/templates/service.yaml` - Headless service + ClusterIP service
- `charts/opennebula/templates/secret.yaml` - Credentials, DB password, SSH keys secrets
- `charts/opennebula/templates/configmap.yaml` - Configuration management placeholder

## Decisions Made

1. **InitContainer with busybox nc** - Simple, reliable wait pattern for MariaDB availability
2. **oneuser show 0 for probes** - Exec-based probe that verifies oned is responsive (not just HTTP port)
3. **Headless service pattern** - Required for StatefulSet stable network identity
4. **lookup function for secrets** - Preserves auto-generated passwords across helm upgrades
5. **SSH keys via PV** - Keys generated by entrypoint persist in /var/lib/one/.ssh via volumeClaimTemplate
6. **Safe nil-check pattern** - `and .Values.ssh (or .Values.ssh.privateKey ...)` prevents nil pointer errors

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Extracted mariadb dependency chart**
- **Found during:** Task 1 verification
- **Issue:** helm template failed with "missing in charts/ directory: mariadb" despite Chart.lock existing
- **Fix:** Extracted mariadb-14.0.3.tgz to charts/mariadb/ directory
- **Files modified:** charts/opennebula/charts/mariadb/
- **Verification:** helm template succeeds

**2. [Rule 1 - Bug] Fixed nil pointer on .Values.ssh.privateKey**
- **Found during:** Task 1 verification
- **Issue:** Template error: nil pointer evaluating interface {}.privateKey
- **Fix:** Added safe nil-check: `and .Values.ssh (or .Values.ssh.privateKey .Values.ssh.publicKey)`
- **Files modified:** charts/opennebula/templates/statefulset.yaml
- **Verification:** helm template renders correctly

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 bug)
**Impact on plan:** Both fixes necessary for template correctness. No scope creep.

## Issues Encountered

- Helm repository cache issue with headlamp (removed stale repo)
- OCI chart pull timing issue where template command ran before download completed

## Next Phase Readiness

- Core templates complete, ready for 03-03 (Ingress + optional components)
- All HELM requirements (01-05) now have template implementations
- Chart lints successfully with one INFO (icon recommended)

---
*Phase: 03-helm-chart-core*
*Completed: 2026-01-24*
