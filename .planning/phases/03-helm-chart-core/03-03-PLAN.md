---
phase: 03-helm-chart-core
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - charts/opennebula/templates/ingress.yaml
  - charts/opennebula/templates/NOTES.txt
  - charts/opennebula/templates/tests/test-connection.yaml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Ingress routes to FireEdge when enabled (HELM-06)"
    - "NOTES.txt provides post-install instructions"
    - "Helm test verifies oned connectivity"
  artifacts:
    - path: "charts/opennebula/templates/ingress.yaml"
      provides: "Optional Ingress for FireEdge"
      contains: "ingress.enabled"
    - path: "charts/opennebula/templates/NOTES.txt"
      provides: "Post-install help text"
      contains: "helm install"
    - path: "charts/opennebula/templates/tests/test-connection.yaml"
      provides: "Helm test for connectivity"
      contains: "helm.sh/hook: test"
  key_links:
    - from: "ingress.yaml"
      to: "service.yaml"
      via: "backend service reference"
      pattern: "fireedge"
---

<objective>
Create optional Ingress template, NOTES.txt for post-install help, and Helm test.

Purpose: Complete the chart with HELM-06 (FireEdge Ingress) and provide good UX with help text and connectivity test.
Output: Full chart ready for local testing with `helm install --dry-run`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-helm-chart-core/03-CONTEXT.md
@.planning/phases/03-helm-chart-core/03-RESEARCH.md
@.planning/phases/03-helm-chart-core/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Ingress template for FireEdge</name>
  <files>charts/opennebula/templates/ingress.yaml</files>
  <action>
Create ingress.yaml implementing HELM-06 (FireEdge accessible via Ingress):

Use networking.k8s.io/v1 API (required - extensions/v1beta1 is deprecated).

Pattern from RESEARCH.md:
```yaml
{{- if .Values.ingress.enabled -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "opennebula.fullname" . }}
  labels:
    {{- include "opennebula.labels" . | nindent 4 }}
  {{- with .Values.ingress.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  rules:
    - host: {{ .Values.ingress.hostname | quote }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ include "opennebula.fullname" . }}
                port:
                  number: 2616
{{- end }}
```

Key points:
- Conditional on ingress.enabled (disabled by default per CONTEXT.md)
- Routes to FireEdge port 2616
- Supports ingressClassName for modern clusters
- Supports annotations for nginx/traefik configuration
- hostname configurable (HELM-06: configurable hostname)
- No TLS in v1 (per CONTEXT.md decision)
  </action>
  <verify>
```bash
helm template test charts/opennebula --set mariadb.enabled=false --set ingress.enabled=true --set ingress.hostname=test.local 2>&1 | grep -q "kind: Ingress" && echo "PASS" || echo "FAIL"
```
  </verify>
  <done>Ingress template conditionally creates networking.k8s.io/v1 Ingress for FireEdge with configurable hostname.</done>
</task>

<task type="auto">
  <name>Task 2: Create NOTES.txt with post-install instructions</name>
  <files>charts/opennebula/templates/NOTES.txt</files>
  <action>
Create NOTES.txt to display after `helm install`:

```
OpenNebula has been installed!

{{- if .Values.mariadb.enabled }}
MariaDB is deployed as a subchart.
{{- end }}

To access the OpenNebula services:

1. Get the FireEdge web UI URL:
{{- if .Values.ingress.enabled }}
   http://{{ .Values.ingress.hostname }}
{{- else }}
   kubectl port-forward svc/{{ include "opennebula.fullname" . }} 2616:2616
   Then visit: http://localhost:2616
{{- end }}

2. Access the oned API:
   kubectl port-forward svc/{{ include "opennebula.fullname" . }} 2633:2633
   oneuser show 0 --endpoint http://localhost:2633

3. Default credentials:
   Username: oneadmin
   Password: {{ .Values.opennebula.adminPassword }}

   IMPORTANT: Change the admin password in production!

4. Check pod status:
   kubectl get pods -l {{ include "opennebula.selectorLabels" . | replace ": " "=" | replace "\n" "," }}

5. View logs:
   kubectl logs -f statefulset/{{ include "opennebula.fullname" . }}

For more information, visit:
https://github.com/pablodelarco/opennebula-helm
```
  </action>
  <verify>
```bash
helm template test charts/opennebula --set mariadb.enabled=false 2>&1 | grep -q "OpenNebula has been installed" && echo "PASS" || echo "FAIL"
```
  </verify>
  <done>NOTES.txt provides helpful post-install instructions for accessing services, default credentials, and troubleshooting.</done>
</task>

<task type="auto">
  <name>Task 3: Create Helm test for oned connectivity</name>
  <files>charts/opennebula/templates/tests/test-connection.yaml</files>
  <action>
Create test-connection.yaml for `helm test`:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "opennebula.fullname" . }}-test-connection"
  labels:
    {{- include "opennebula.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox:1.36
      command: ['wget']
      args: ['{{ include "opennebula.fullname" . }}:2633', '-O', '/dev/null', '-T', '5']
  restartPolicy: Never
```

This test:
- Runs as a Helm hook (helm.sh/hook: test)
- Attempts to connect to oned API port
- Uses busybox wget for minimal image
- 5 second timeout for quick feedback
- Runs with `helm test <release-name>`
  </action>
  <verify>
```bash
helm template test charts/opennebula --set mariadb.enabled=false 2>&1 | grep -q "helm.sh/hook: test" && echo "PASS" || echo "FAIL"
```
  </verify>
  <done>Helm test pod attempts connection to oned service to verify deployment health.</done>
</task>

</tasks>

<verification>
After all tasks:
```bash
# Full chart lint
helm lint charts/opennebula --set mariadb.enabled=false

# Template all resources
helm template test charts/opennebula --set mariadb.enabled=false

# Verify Ingress renders when enabled
helm template test charts/opennebula --set mariadb.enabled=false --set ingress.enabled=true --set ingress.hostname=test.local | grep -A10 "kind: Ingress"

# Verify NOTES.txt content
helm template test charts/opennebula --set mariadb.enabled=false --show-notes
```
</verification>

<success_criteria>
- Ingress template creates networking.k8s.io/v1 Ingress when enabled (HELM-06)
- Ingress routes to FireEdge service port 2616
- Ingress hostname is configurable via values
- NOTES.txt displays helpful post-install instructions
- Helm test pod verifies oned connectivity
- Full `helm lint` passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-helm-chart-core/03-03-SUMMARY.md`
</output>
