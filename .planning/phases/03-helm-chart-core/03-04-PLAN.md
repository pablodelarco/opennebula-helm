---
phase: 03-helm-chart-core
plan: 04
type: execute
wave: 4
depends_on: ["03-03"]
files_modified:
  - .github/workflows/release-chart.yaml
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Chart releases to GitHub Pages when charts/ changes on main"
    - "Users can helm repo add and helm install"
  artifacts:
    - path: ".github/workflows/release-chart.yaml"
      provides: "Automated chart publishing workflow"
      contains: "chart-releaser-action"
  key_links:
    - from: "release-chart.yaml"
      to: "charts/opennebula/Chart.yaml"
      via: "charts_dir parameter"
      pattern: "charts_dir: charts"
---

<objective>
Create GitHub Actions workflow for chart publishing using chart-releaser-action.

Purpose: Enable users to install the chart via `helm repo add` + `helm install` (critical constraint from CONTEXT.md).
Output: Working CI/CD that publishes chart to GitHub Pages on release.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-helm-chart-core/03-CONTEXT.md
@.planning/phases/03-helm-chart-core/03-RESEARCH.md
@.planning/phases/03-helm-chart-core/03-03-SUMMARY.md
@.github/workflows/docker-build.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chart-releaser workflow</name>
  <files>.github/workflows/release-chart.yaml</files>
  <action>
Create release-chart.yaml using chart-releaser-action (from RESEARCH.md):

```yaml
name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
      pages: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Update Helm dependencies
        run: |
          for chart in charts/*/; do
            helm dependency update "$chart"
          done

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.7.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
```

Key points:
- Triggers on push to main when charts/ changes (from RESEARCH.md pattern)
- workflow_dispatch for manual releases
- permissions: contents: write for releases, pages: write for gh-pages
- fetch-depth: 0 required for chart-releaser to detect changes
- helm dependency update before release (handles MariaDB subchart)
- Uses GITHUB_TOKEN (no additional secrets needed)

This workflow will:
1. Package charts that have changed (version bump in Chart.yaml)
2. Create GitHub releases with chart tarballs
3. Update gh-pages branch with index.yaml

After first run, users can:
```bash
helm repo add opennebula https://pablodelarco.github.io/opennebula-helm
helm install my-opennebula opennebula/opennebula
```
  </action>
  <verify>
```bash
# Verify workflow syntax
cat .github/workflows/release-chart.yaml | head -20
# Check for required elements
grep -E "(chart-releaser-action|charts_dir|GITHUB_TOKEN)" .github/workflows/release-chart.yaml && echo "PASS" || echo "FAIL"
```
  </verify>
  <done>GitHub Actions workflow publishes chart to GitHub Pages using chart-releaser-action when charts/ changes on main.</done>
</task>

<task type="auto">
  <name>Task 2: Validate complete chart and document repository setup</name>
  <files>charts/opennebula/Chart.yaml</files>
  <action>
Final validation of the complete Helm chart:

1. Run full helm lint with strict mode:
```bash
helm lint charts/opennebula --strict
```

2. Test dry-run install (mariadb disabled to avoid OCI pull):
```bash
helm template test charts/opennebula --set mariadb.enabled=false --validate
```

3. Test with mariadb enabled (requires dependency update):
```bash
helm dependency update charts/opennebula
helm template test-full charts/opennebula --validate
```

4. Verify chart structure matches expected:
```
charts/opennebula/
├── .helmignore
├── Chart.yaml
├── values.yaml
├── charts/          # (empty until helm dep update)
└── templates/
    ├── _helpers.tpl
    ├── configmap.yaml
    ├── ingress.yaml
    ├── NOTES.txt
    ├── secret.yaml
    ├── service.yaml
    ├── statefulset.yaml
    └── tests/
        └── test-connection.yaml
```

No file modifications needed in this task - this is validation only.
Update Chart.yaml only if issues found (e.g., missing fields).
  </action>
  <verify>
```bash
helm lint charts/opennebula --set mariadb.enabled=false --strict 2>&1 | grep -E "(ERROR|0 chart)"
```
Should show "0 chart(s) linted" or no ERROR lines.
  </verify>
  <done>Complete chart passes helm lint --strict and renders all expected Kubernetes resources.</done>
</task>

</tasks>

<verification>
After all tasks:
```bash
# Workflow file exists and is valid YAML
python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release-chart.yaml'))" && echo "YAML valid"

# Chart passes strict lint
helm lint charts/opennebula --set mariadb.enabled=false --strict

# All expected files exist
ls -la charts/opennebula/templates/

# Template produces valid K8s manifests
helm template test charts/opennebula --set mariadb.enabled=false --validate
```
</verification>

<success_criteria>
- release-chart.yaml workflow uses chart-releaser-action@v1.7.0
- Workflow triggers on charts/** changes to main branch
- Workflow runs helm dependency update before release
- Complete chart passes `helm lint --strict`
- All templates render without errors
- Chart structure matches expected layout
- Ready for users to `helm repo add` after first release
</success_criteria>

<output>
After completion, create `.planning/phases/03-helm-chart-core/03-04-SUMMARY.md`
</output>
