---
phase: 02-cicd-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Push to main triggers workflow and builds image"
    - "Image appears on Docker Hub with correct tags"
    - "Trivy scan runs and reports vulnerabilities"
    - "Scheduled workflow can detect OpenNebula versions"
  artifacts: []
  key_links:
    - from: "GitHub Actions workflow"
      to: "Docker Hub registry"
      via: "docker/login-action + docker/build-push-action"
      pattern: "pablodelarco/opennebula-frontend"
---

<objective>
Test the CI/CD workflow by triggering a build and verifying end-to-end functionality

Purpose: Verify that the GitHub Actions workflow correctly builds the Docker image, scans for vulnerabilities, and pushes to Docker Hub with proper tags. This requires pushing code and observing the workflow execution.

Output: Verified working CI/CD pipeline with image on Docker Hub
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cicd-pipeline/02-01-SUMMARY.md
@.github/workflows/docker-build.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify workflow syntax locally</name>
  <files></files>
  <action>
Before pushing, validate the workflow file:

1. Check YAML syntax is valid:
   - Use a YAML linter if available, or manually verify structure

2. Verify all required elements are present:
   - Check triggers: push, schedule, workflow_dispatch
   - Check jobs: detect-version, build-scan-push
   - Check secrets references: DOCKERHUB_USERNAME, DOCKERHUB_TOKEN
   - Check Trivy configuration: exit-code, severity

3. If any issues found, fix them before proceeding.
  </action>
  <verify>cat .github/workflows/docker-build.yml shows valid structure with no obvious syntax errors</verify>
  <done>Workflow file passes local syntax validation</done>
</task>

<task type="auto">
  <name>Task 2: Commit and push workflow to trigger build</name>
  <files></files>
  <action>
Commit the workflow file and push to trigger the CI/CD pipeline:

1. Stage the workflow file:
   git add .github/workflows/docker-build.yml

2. Commit with descriptive message:
   git commit -m "ci: add Docker build workflow with Trivy scanning

   - Build on push to main (docker/** changes)
   - Daily scheduled check for new OpenNebula releases
   - Trivy vulnerability scan (fail on CRITICAL/HIGH)
   - Push to Docker Hub with version and latest tags"

3. Push to main branch:
   git push origin main

4. Record the commit SHA for tracking.

Note: This will trigger the workflow because the workflow file itself is in the paths filter.
  </action>
  <verify>git log -1 shows the commit, git push output shows successful push to main</verify>
  <done>Workflow file committed and pushed to main, build triggered</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete CI/CD pipeline:
- GitHub Actions workflow that builds Docker images
- Trivy vulnerability scanning
- Docker Hub push with version tags
  </what-built>
  <how-to-verify>
**Step 1: Check GitHub Actions**
1. Go to: https://github.com/pablodelarco/kubernetes-homelab/actions
2. Look for "Docker Build and Push" workflow
3. Click on the latest run triggered by your push
4. Verify all jobs complete successfully:
   - detect-version job: Should output the OpenNebula version
   - build-scan-push job: Should show Trivy scan and Docker push

**Step 2: Check Trivy Scan Results**
1. In the workflow run, expand "Run Trivy vulnerability scanner" step
2. Verify it shows scan results in table format
3. Confirm it either passes (no CRITICAL/HIGH) or lists found vulnerabilities
   - If vulnerabilities found and build failed, that's expected behavior
   - You may need to address vulnerabilities or adjust severity thresholds

**Step 3: Check Docker Hub (if build succeeded)**
1. Go to: https://hub.docker.com/r/pablodelarco/opennebula-frontend/tags
2. Verify new tags appear:
   - Version tag (e.g., 7.0.1)
   - latest tag
3. Check the "Last pushed" timestamp matches your build

**Step 4: Test Manual Trigger (optional)**
1. Go to: https://github.com/pablodelarco/kubernetes-homelab/actions
2. Click "Docker Build and Push" workflow
3. Click "Run workflow" button
4. Optionally specify a version, or leave blank to auto-detect
5. Verify workflow runs successfully

**Troubleshooting:**
- If secrets error: Add DOCKERHUB_USERNAME and DOCKERHUB_TOKEN in repo Settings -> Secrets
- If Trivy fails: Check vulnerability report - may need to update base image or ignore specific CVEs
- If version detection fails: Check curl output in detect-version job logs
  </how-to-verify>
  <resume-signal>
Type one of:
- "approved" - if all checks pass and image is on Docker Hub
- "trivy-failed" - if Trivy found vulnerabilities (describe which)
- "secrets-missing" - if authentication failed (need to add secrets)
- Describe any other issues encountered
  </resume-signal>
</task>

</tasks>

<verification>
Phase 2 is complete when:
1. Workflow runs successfully on push to main
2. Trivy scan executes and reports results
3. Docker image appears on Docker Hub with version tag and latest
4. Workflow can be manually triggered via workflow_dispatch
</verification>

<success_criteria>
- CI-01: GitHub Actions workflow builds Docker image on push/tag (VERIFIED by workflow run)
- CI-02: Scheduled workflow detects OpenNebula releases (VERIFIED by version detection logic)
- CI-03: Images pushed to Docker Hub pablodelarco/opennebula-frontend (VERIFIED by tag presence)
- CI-04: Trivy scanning fails on CRITICAL/HIGH (VERIFIED by scan step configuration)
- CI-05: Image tags align with OpenNebula version (VERIFIED by tag format)
</success_criteria>

<output>
After completion, create `.planning/phases/02-cicd-pipeline/02-02-SUMMARY.md`
</output>
