---
phase: 02-cicd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/docker-build.yml
autonomous: true

user_setup:
  - service: docker-hub
    why: "Push images to Docker Hub registry"
    env_vars:
      - name: DOCKERHUB_USERNAME
        source: "Docker Hub username (pablodelarco)"
      - name: DOCKERHUB_TOKEN
        source: "Docker Hub -> Account Settings -> Security -> New Access Token"
    dashboard_config:
      - task: "Create access token with Read/Write permissions"
        location: "https://hub.docker.com/settings/security"
      - task: "Add DOCKERHUB_USERNAME and DOCKERHUB_TOKEN as repository secrets"
        location: "GitHub repo -> Settings -> Secrets and variables -> Actions -> New repository secret"

must_haves:
  truths:
    - "Workflow triggers on push to main when docker/ files change"
    - "Workflow triggers on daily schedule at 3:15 AM UTC"
    - "Workflow detects new OpenNebula releases by polling downloads.opennebula.io"
    - "Trivy scans image before push and fails on CRITICAL/HIGH vulnerabilities"
    - "Images are tagged with OpenNebula version and latest"
  artifacts:
    - path: ".github/workflows/docker-build.yml"
      provides: "Complete CI/CD pipeline for Docker image builds"
      contains: "docker/build-push-action@v6"
  key_links:
    - from: ".github/workflows/docker-build.yml"
      to: "docker/Dockerfile"
      via: "context: ./docker in build step"
      pattern: "context:.*docker"
    - from: ".github/workflows/docker-build.yml"
      to: "downloads.opennebula.io"
      via: "curl to detect latest version"
      pattern: "downloads.opennebula.io/repo"
---

<objective>
Create the GitHub Actions workflow file for automated Docker image builds

Purpose: Establish CI/CD automation that builds Docker images on code changes, detects new OpenNebula releases via scheduled polling, scans for vulnerabilities with Trivy, and pushes to Docker Hub with version-aligned tags.

Output: A complete workflow file at .github/workflows/docker-build.yml
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cicd-pipeline/02-RESEARCH.md
@docker/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow directory</name>
  <files>.github/workflows/</files>
  <action>
Create the directory structure for GitHub Actions:
- mkdir -p .github/workflows

This prepares for the workflow file creation.
  </action>
  <verify>ls -la .github/workflows/ shows the directory exists</verify>
  <done>Directory .github/workflows/ exists</done>
</task>

<task type="auto">
  <name>Task 2: Create docker-build.yml workflow file</name>
  <files>.github/workflows/docker-build.yml</files>
  <action>
Create the complete GitHub Actions workflow with the following structure:

**Name:** Docker Build and Push

**Triggers (on:):**
1. push:
   - branches: [main]
   - paths: ['docker/**', '.github/workflows/docker-build.yml']
2. workflow_dispatch:
   - inputs.opennebula_version (optional string, description: "OpenNebula version to build")
3. schedule:
   - cron: '15 3 * * *' (daily at 3:15 AM UTC)

**Concurrency:**
- group: docker-build-${{ github.ref }}
- cancel-in-progress: true

**Environment variables (env:):**
- REGISTRY: docker.io
- IMAGE_NAME: pablodelarco/opennebula-frontend

**Jobs:**

**Job 1: detect-version**
- runs-on: ubuntu-latest
- outputs:
  - version: ${{ steps.detect.outputs.version }}
  - should_build: ${{ steps.detect.outputs.should_build }}
- steps:
  1. name: Detect OpenNebula version
     id: detect
     run: |
       # Use workflow_dispatch input if provided
       if [ -n "${{ github.event.inputs.opennebula_version }}" ]; then
         VERSION="${{ github.event.inputs.opennebula_version }}"
       else
         # Detect latest from OpenNebula downloads page
         VERSION=$(curl -s https://downloads.opennebula.io/repo/ | \
           grep -oP 'href="[0-9]+\.[0-9]+\.[0-9]+/"' | \
           grep -oP '[0-9]+\.[0-9]+\.[0-9]+' | \
           sort -V | tail -1)
       fi
       echo "Detected version: ${VERSION}"
       echo "version=${VERSION}" >> $GITHUB_OUTPUT

       # For scheduled runs, check if image already exists on Docker Hub
       if [ "${{ github.event_name }}" = "schedule" ]; then
         if docker manifest inspect ${{ env.IMAGE_NAME }}:${VERSION} > /dev/null 2>&1; then
           echo "Image already exists for version ${VERSION}, skipping build"
           echo "should_build=false" >> $GITHUB_OUTPUT
         else
           echo "New version detected, triggering build"
           echo "should_build=true" >> $GITHUB_OUTPUT
         fi
       else
         # Always build for push and workflow_dispatch
         echo "should_build=true" >> $GITHUB_OUTPUT
       fi

**Job 2: build-scan-push**
- needs: detect-version
- if: needs.detect-version.outputs.should_build == 'true'
- runs-on: ubuntu-latest
- steps:
  1. name: Checkout
     uses: actions/checkout@v4

  2. name: Set up Docker Buildx
     uses: docker/setup-buildx-action@v3

  3. name: Login to Docker Hub
     uses: docker/login-action@v3
     with:
       username: ${{ secrets.DOCKERHUB_USERNAME }}
       password: ${{ secrets.DOCKERHUB_TOKEN }}

  4. name: Build image for scanning
     uses: docker/build-push-action@v6
     with:
       context: ./docker
       load: true
       tags: ${{ env.IMAGE_NAME }}:scan

  5. name: Run Trivy vulnerability scanner
     uses: aquasecurity/trivy-action@0.33.1
     with:
       image-ref: ${{ env.IMAGE_NAME }}:scan
       format: 'table'
       exit-code: '1'
       ignore-unfixed: true
       severity: 'CRITICAL,HIGH'

  6. name: Build and push
     uses: docker/build-push-action@v6
     with:
       context: ./docker
       push: true
       tags: |
         ${{ env.IMAGE_NAME }}:${{ needs.detect-version.outputs.version }}
         ${{ env.IMAGE_NAME }}:latest
       cache-from: type=gha
       cache-to: type=gha,mode=max

  7. name: Summary
     run: |
       echo "## Docker Build Complete" >> $GITHUB_STEP_SUMMARY
       echo "" >> $GITHUB_STEP_SUMMARY
       echo "**Image:** ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
       echo "**Version:** ${{ needs.detect-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
       echo "**Tags:** ${{ needs.detect-version.outputs.version }}, latest" >> $GITHUB_STEP_SUMMARY

**Important notes:**
- Use YAML syntax correctly (proper indentation, no tabs)
- The version regex pattern captures all semver versions (not just 7.x)
- ignore-unfixed: true means only actionable vulnerabilities fail the build
- cache-from/cache-to uses GitHub Actions cache for faster builds
  </action>
  <verify>
1. cat .github/workflows/docker-build.yml shows valid YAML structure
2. grep -c "docker/build-push-action" .github/workflows/docker-build.yml returns 2 (scan build + push build)
3. grep "aquasecurity/trivy-action" .github/workflows/docker-build.yml shows Trivy is configured
4. grep "severity: 'CRITICAL,HIGH'" .github/workflows/docker-build.yml confirms severity settings
  </verify>
  <done>
Workflow file exists at .github/workflows/docker-build.yml with:
- Push trigger on main for docker/** changes
- Schedule trigger at 3:15 AM UTC daily
- workflow_dispatch with optional version input
- OpenNebula version detection from downloads page
- Docker Hub image existence check for scheduled runs
- Trivy vulnerability scanning that fails on CRITICAL/HIGH
- Build and push with version and latest tags
- Concurrency control to prevent race conditions
  </done>
</task>

</tasks>

<verification>
After tasks complete:
1. .github/workflows/docker-build.yml exists and is valid YAML
2. Workflow has all three triggers (push, schedule, workflow_dispatch)
3. Trivy scan step has exit-code: '1' and severity: 'CRITICAL,HIGH'
4. Build step pushes to pablodelarco/opennebula-frontend with version tag and latest
5. Concurrency group is configured to prevent race conditions
</verification>

<success_criteria>
- Workflow file is syntactically valid YAML
- Contains all required triggers (push on docker/**, schedule at 3:15 UTC, workflow_dispatch)
- Version detection polls downloads.opennebula.io/repo/
- Trivy scanning configured to fail on CRITICAL/HIGH vulnerabilities
- Docker Hub push uses correct image name and tags
- Ready for testing (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/02-cicd-pipeline/02-01-SUMMARY.md`
</output>
