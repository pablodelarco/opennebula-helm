# Milestone v1.1: Production Hardening

**Status:** ✅ SHIPPED 2026-02-03
**Phases:** 1-4
**Total Plans:** 10

## Overview

This roadmap delivers a production-ready OpenNebula Helm chart in 4 phases: first build a Docker image with OpenNebula 7.0 and all control plane services (oned, Sunstone, FireEdge, OneFlow, OneGate), then establish CI/CD automation for builds and release detection, create the Helm chart with MariaDB integration, persistent storage, and Kubernetes-native patterns, and finally add production hardening for hypervisor communication.

## Phases

### Phase 1: Docker Image

**Goal**: Users can pull a working Docker image that runs OpenNebula 7.0 control plane without systemd
**Depends on**: Nothing (first phase)
**Requirements**: IMG-01, IMG-02, IMG-03, IMG-04, IMG-05
**Plans**: 2 plans

Plans:
- [x] 01-01-PLAN.md — Create Dockerfile, supervisord config, and entrypoint script
- [x] 01-02-PLAN.md — Build and verify Docker image works

**Details:**
- Ubuntu 24.04 LTS base image
- OpenNebula 7.0 packages from official repository
- supervisord for process management (no systemd)
- Environment variables for runtime configuration
- Services: oned, FireEdge/Sunstone, OneFlow, OneGate

### Phase 2: CI/CD Pipeline

**Goal**: Docker images build automatically on code changes and when new OpenNebula releases are detected
**Depends on**: Phase 1 (needs image to build/push)
**Requirements**: CI-01, CI-02, CI-03, CI-04, CI-05
**Plans**: 2 plans

Plans:
- [x] 02-01-PLAN.md — Create GitHub Actions workflow for Docker builds
- [x] 02-02-PLAN.md — Test workflow and verify Docker Hub deployment

**Details:**
- Push trigger on main branch
- Scheduled version detection from downloads.opennebula.io
- Trivy vulnerability scanning with CRITICAL/HIGH gates
- Docker Hub publishing with version and latest tags

### Phase 3: Helm Chart Core

**Goal**: Users can deploy OpenNebula on Kubernetes with a single helm install command
**Depends on**: Phase 1 (deploys the Docker image)
**Requirements**: HELM-01, HELM-02, HELM-03, HELM-04, HELM-05, HELM-06, HELM-07
**Plans**: 4 plans

Plans:
- [x] 03-01-PLAN.md — Create chart skeleton (Chart.yaml, values.yaml, _helpers.tpl)
- [x] 03-02-PLAN.md — Create core templates (StatefulSet, Service, ConfigMap, Secret)
- [x] 03-03-PLAN.md — Create Ingress, NOTES.txt, and Helm test
- [x] 03-04-PLAN.md — Setup chart publishing (GitHub Actions for chart-releaser)

**Details:**
- StatefulSet with persistent volume for /var/lib/one
- MariaDB subchart (Bitnami ~14.0) with external DB option
- SSH key persistence via secrets and PV
- Ingress for FireEdge UI
- Liveness/readiness probes using oneuser command
- Chart publishing to GitHub Pages

### Phase 4: Production Hardening

**Goal**: OpenNebula chart works in production with proper networking for hypervisor communication
**Depends on**: Phase 3 (extends existing chart)
**Requirements**: PROD-01, PROD-02, PROD-03, PROD-04
**Plans**: 2 plans

Plans:
- [x] 04-01-PLAN.md — Add monitoring and SSH ports to Dockerfile, Service, StatefulSet
- [x] 04-02-PLAN.md — Configure hostname and monitor address settings

**Details:**
- Port 4124 TCP/UDP for monitoring probes
- Port 22 for SSH transfer manager
- HOSTNAME configuration via StatefulSet FQDN default
- MONITOR_ADDRESS configurable for external hypervisors
- VNM transparent proxy documentation

---

## Milestone Summary

**Key Decisions:**
- supervisord for process management (container-native, no systemd)
- RUNLEVEL=1 to prevent service auto-start during apt install
- Two-job CI pipeline (detect-version -> build-scan-push)
- OCI registry for MariaDB dependency (Bitnami format)
- mariadb.enabled=true by default for simplest quickstart
- InitContainer with busybox nc for MariaDB wait
- oneuser show 0 for health probes (exec-based)
- lookup function for secret persistence across upgrades
- chart-releaser-action@v1.7.0 for GitHub Pages publishing
- Port names monitord-tcp and monitord-udp for dual-protocol clarity
- Empty hostname default uses StatefulSet FQDN for stability

**Issues Resolved:**
- Production feedback: port 4124 UDP missing (resolved in 04-01)
- Production feedback: port 22 missing (resolved in 04-01)
- Production feedback: hostname issues (resolved in 04-02)
- Trivy SSH key false positive (scanners: 'vuln' only)

**Technical Debt Incurred:**
- Port 9869 (Sunstone) declared in StatefulSet but not exposed (cosmetic)
- vnm.tproxy section not consumed by templates (hypervisor-side config)

---

*For current project status, see .planning/MILESTONES.md*
