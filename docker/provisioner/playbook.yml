---
# OpenNebula Host Provisioner Playbook
# Provisions hypervisor nodes and registers them with the front-end
#
# Compatible with OneDeploy inventory format

- name: Provision OpenNebula Hypervisor Nodes
  hosts: all:!localhost
  become: true
  gather_facts: true
  vars:
    one_version: "{{ hostvars['localhost']['one_version'] | default('7.0') }}"
    virtualization: "{{ hostvars[inventory_hostname]['virtualization'] | default('kvm') }}"

  roles:
    - role: opennebula-node


- name: Create Virtual Networks
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    frontend_host: "{{ lookup('env', 'FRONTEND_HOST') | default('opennebula', true) }}"
    frontend_port: "{{ lookup('env', 'FRONTEND_PORT') | default('2633', true) }}"

  roles:
    - role: opennebula-network
      when: vn is defined


- name: Register Hosts with OpenNebula
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    frontend_host: "{{ lookup('env', 'FRONTEND_HOST') | default('opennebula', true) }}"
    frontend_port: "{{ lookup('env', 'FRONTEND_PORT') | default('2633', true) }}"

  roles:
    - role: opennebula-register
