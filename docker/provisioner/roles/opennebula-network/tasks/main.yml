---
# OpenNebula Virtual Network Creation Role
# Creates virtual networks defined in the inventory

- name: Set authentication
  ansible.builtin.set_fact:
    one_auth: "oneadmin:{{ oneadmin_password | default('opennebula') }}"

- name: Display virtual networks to create
  ansible.builtin.debug:
    msg: "Will create virtual network: {{ item.key }}"
  loop: "{{ vn | dict2items }}"
  when: item.value.managed | default(true)

- name: Create virtual network template files
  ansible.builtin.template:
    src: vnet.tmpl.j2
    dest: "/tmp/vnet_{{ item.key }}.tmpl"
    mode: '0644'
  loop: "{{ vn | dict2items }}"
  when: item.value.managed | default(true)
  delegate_to: localhost

- name: Check if virtual network already exists
  ansible.builtin.shell: |
    ONE_AUTH="{{ one_auth }}"
    VNET_NAME="{{ item.key }}"

    RESULT=$(curl -s -X POST \
      "http://{{ frontend_host }}:{{ frontend_port }}/RPC2" \
      -d "<?xml version='1.0'?>
      <methodCall>
        <methodName>one.vnpool.info</methodName>
        <params>
          <param><value><string>${ONE_AUTH}</string></value></param>
          <param><value><i4>-2</i4></value></param>
          <param><value><i4>-1</i4></value></param>
          <param><value><i4>-1</i4></value></param>
        </params>
      </methodCall>")

    # Unescape HTML entities in the response (API returns escaped XML)
    RESULT=$(echo "$RESULT" | sed 's/&lt;/</g; s/&gt;/>/g; s/&amp;/\&/g; s/&quot;/"/g')

    if echo "$RESULT" | grep -q "<NAME>${VNET_NAME}</NAME>"; then
      echo "EXISTS"
    else
      echo "NOT_FOUND"
    fi
  args:
    executable: /bin/bash
  loop: "{{ vn | dict2items }}"
  when: item.value.managed | default(true)
  delegate_to: localhost
  register: vnet_check
  changed_when: false

- name: Create virtual networks via API
  ansible.builtin.shell: |
    ONE_AUTH="{{ one_auth }}"
    # Read the template
    TEMPLATE=$(cat /tmp/vnet_{{ item.item.key }}.tmpl)

    # Create network via XML-RPC
    RESULT=$(curl -s -X POST \
      "http://{{ frontend_host }}:{{ frontend_port }}/RPC2" \
      -d "<?xml version='1.0'?>
      <methodCall>
        <methodName>one.vn.allocate</methodName>
        <params>
          <param><value><string>${ONE_AUTH}</string></value></param>
          <param><value><string>${TEMPLATE}</string></value></param>
          <param><value><i4>-1</i4></value></param>
        </params>
      </methodCall>")

    if echo "$RESULT" | grep -q "<boolean>1</boolean>"; then
      VNET_ID=$(echo "$RESULT" | sed -n 's/.*<i4>\([0-9]*\)<\/i4>.*/\1/p' | head -1)
      echo "Virtual network {{ item.item.key }} created with ID ${VNET_ID}"
    else
      echo "Failed to create network {{ item.item.key }}"
      echo "$RESULT"
      exit 1
    fi
  args:
    executable: /bin/bash
  loop: "{{ vnet_check.results }}"
  when:
    - item.item.value.managed | default(true)
    - item.stdout == "NOT_FOUND"
  delegate_to: localhost
  register: vnet_result
  changed_when: "'created with ID' in vnet_result.stdout"

- name: Display network creation results
  ansible.builtin.debug:
    msg: "{{ item.stdout_lines | default(['Skipped - already exists']) }}"
  loop: "{{ vnet_result.results | default([]) }}"
  loop_control:
    label: "{{ item.item.item.key | default('network') }}"
  when: vnet_result.results is defined
