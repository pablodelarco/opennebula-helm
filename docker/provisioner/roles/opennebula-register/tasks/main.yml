---
# OpenNebula Host Registration Role
# Registers provisioned hosts with the OpenNebula front-end and syncs remotes

- name: Build list of hosts to register
  ansible.builtin.set_fact:
    hosts_to_register: "{{ groups['all'] | difference(['localhost']) | list }}"
    one_auth: "oneadmin:{{ oneadmin_password | default('opennebula') }}"

- name: Display hosts to register
  ansible.builtin.debug:
    msg: "Will register {{ hosts_to_register | length }} host(s): {{ hosts_to_register | join(', ') }}"

- name: Wait for SSH connectivity to hosts
  ansible.builtin.wait_for:
    host: "{{ hostvars[item]['ansible_host'] }}"
    port: 22
    timeout: 60
  loop: "{{ hosts_to_register }}"
  delegate_to: localhost

- name: Register hosts with OpenNebula
  ansible.builtin.shell:
    cmd: |
      VIRT_TYPE="{{ hostvars[item]['virtualization'] | default('kvm') }}"
      HOST_IP="{{ hostvars[item]['ansible_host'] }}"
      ONE_AUTH="{{ one_auth }}"
      API_URL="http://{{ frontend_host }}:{{ frontend_port }}/RPC2"

      # Check if host already exists
      EXISTING=$(curl -s -X POST "$API_URL" \
        -d "<?xml version=\"1.0\"?>
        <methodCall>
          <methodName>one.hostpool.info</methodName>
          <params>
            <param><value><string>${ONE_AUTH}</string></value></param>
          </params>
        </methodCall>" | grep -c "${HOST_IP}" || echo "0")

      # Handle grep output which might have newlines
      EXISTING=$(echo "$EXISTING" | tr -d '\n' | awk '{print $1}')

      if [ "$EXISTING" -gt "0" ] 2>/dev/null; then
        echo "Host ${HOST_IP} already registered"
        exit 0
      fi

      # Register host
      RESULT=$(curl -s -X POST "$API_URL" \
        -d "<?xml version=\"1.0\"?>
        <methodCall>
          <methodName>one.host.allocate</methodName>
          <params>
            <param><value><string>${ONE_AUTH}</string></value></param>
            <param><value><string>${HOST_IP}</string></value></param>
            <param><value><string>${VIRT_TYPE}</string></value></param>
            <param><value><string>${VIRT_TYPE}</string></value></param>
            <param><value><int>-1</int></value></param>
          </params>
        </methodCall>")

      if echo "$RESULT" | grep -q "<boolean>1</boolean>"; then
        # Extract host ID using sed (portable, no -P needed)
        HOST_ID=$(echo "$RESULT" | sed -n 's/.*<i4>\([0-9]*\)<\/i4>.*/\1/p' | head -1)
        echo "Host ${HOST_IP} registered with ID ${HOST_ID}"
      else
        echo "Registration failed: $RESULT"
        exit 1
      fi
    executable: /bin/bash
  loop: "{{ hosts_to_register }}"
  delegate_to: localhost
  register: register_result
  changed_when: "'registered with ID' in register_result.stdout"

- name: Display registration results
  ansible.builtin.debug:
    msg: "{{ item.stdout_lines | default(['No output']) }}"
  loop: "{{ register_result.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Collect SSH host keys from registered hosts
  ansible.builtin.shell:
    cmd: |
      HOST_IP="{{ hostvars[item]['ansible_host'] }}"
      echo "Scanning SSH host key for ${HOST_IP}..."
      ssh-keyscan -H "${HOST_IP}" 2>/dev/null
    executable: /bin/bash
  loop: "{{ hosts_to_register }}"
  delegate_to: localhost
  register: host_keys_result
  changed_when: false

- name: Store host keys for frontend consumption
  ansible.builtin.copy:
    content: |
      {% for result in host_keys_result.results %}
      {{ result.stdout }}
      {% endfor %}
    dest: /tmp/known_hosts_additions
    mode: '0644'
  delegate_to: localhost
  when: host_keys_result.results | length > 0

- name: Wait for initial monitoring
  ansible.builtin.pause:
    seconds: 15
    prompt: "Waiting for initial host monitoring..."

- name: Sync remotes to all registered hosts
  ansible.builtin.shell:
    cmd: |
      HOST_IP="{{ hostvars[item]['ansible_host'] }}"
      ONE_AUTH="{{ one_auth }}"
      API_URL="http://{{ frontend_host }}:{{ frontend_port }}/RPC2"

      echo "Syncing remotes to ${HOST_IP}..."

      # Get host info
      HOST_INFO=$(curl -s -X POST "$API_URL" \
        -d "<?xml version=\"1.0\"?>
        <methodCall>
          <methodName>one.hostpool.info</methodName>
          <params>
            <param><value><string>${ONE_AUTH}</string></value></param>
          </params>
        </methodCall>")

      # Unescape HTML entities in the response (API returns escaped XML)
      HOST_INFO=$(echo "$HOST_INFO" | sed 's/&lt;/</g; s/&gt;/>/g; s/&amp;/\&/g; s/&quot;/"/g')

      # Extract host ID using sed (portable)
      # Find the HOST block containing our IP and extract its ID
      HOST_ID=$(echo "$HOST_INFO" | tr '\n' ' ' | sed 's/<HOST>/\n<HOST>/g' | grep "${HOST_IP}" | sed -n 's/.*<ID>\([0-9]*\)<\/ID>.*/\1/p' | head -1)

      if [ -z "$HOST_ID" ]; then
        echo "Could not find host ID for ${HOST_IP}"
        exit 1
      fi

      echo "Found host ID: ${HOST_ID}"

      # Sync remotes
      SYNC_RESULT=$(curl -s -X POST "$API_URL" \
        -d "<?xml version=\"1.0\"?>
        <methodCall>
          <methodName>one.host.sync</methodName>
          <params>
            <param><value><string>${ONE_AUTH}</string></value></param>
            <param><value><i4>${HOST_ID}</i4></value></param>
            <param><value><boolean>1</boolean></value></param>
          </params>
        </methodCall>")

      if echo "$SYNC_RESULT" | grep -q "<boolean>1</boolean>"; then
        echo "Remotes synced to ${HOST_IP}"
      else
        echo "Sync warning: $SYNC_RESULT"
      fi

      # Enable host
      curl -s -X POST "$API_URL" \
        -d "<?xml version=\"1.0\"?>
        <methodCall>
          <methodName>one.host.status</methodName>
          <params>
            <param><value><string>${ONE_AUTH}</string></value></param>
            <param><value><i4>${HOST_ID}</i4></value></param>
            <param><value><i4>0</i4></value></param>
          </params>
        </methodCall>" > /dev/null

      echo "Host ${HOST_IP} enabled"
    executable: /bin/bash
  loop: "{{ hosts_to_register }}"
  delegate_to: localhost
  register: sync_result

- name: Display sync results
  ansible.builtin.debug:
    msg: "{{ item.stdout_lines | default(['No output']) }}"
  loop: "{{ sync_result.results }}"
  loop_control:
    label: "{{ item.item }}"

- name: Wait for hosts to become active
  ansible.builtin.pause:
    seconds: 60
    prompt: "Waiting for hosts to be fully monitored..."

- name: Verify host status
  ansible.builtin.shell:
    cmd: |
      ONE_AUTH="{{ one_auth }}"
      API_URL="http://{{ frontend_host }}:{{ frontend_port }}/RPC2"
      RESPONSE=$(curl -s -X POST "$API_URL" \
        -d "<?xml version=\"1.0\"?>
        <methodCall>
          <methodName>one.hostpool.info</methodName>
          <params>
            <param><value><string>${ONE_AUTH}</string></value></param>
          </params>
        </methodCall>")

      # Extract host names and states using sed
      echo "$RESPONSE" | tr '\n' ' ' | sed 's/<HOST>/\n/g' | grep '<NAME>' | while read -r line; do
        NAME=$(echo "$line" | sed -n 's/.*<NAME>\([^<]*\)<\/NAME>.*/\1/p')
        STATE=$(echo "$line" | sed -n 's/.*<STATE>\([^<]*\)<\/STATE>.*/\1/p')
        echo "${NAME}: state=${STATE}"
      done
    executable: /bin/bash
  delegate_to: localhost
  register: host_list

- name: Display registered hosts
  ansible.builtin.debug:
    msg: |
      Registered hosts:
      {{ host_list.stdout }}
      State: 0=INIT, 2=MONITORED (ready), 3=ERROR
